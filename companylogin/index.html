<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD-ArzjlwKTZVpsH4ERg7n-MEgzCt6Nzno",
  authDomain: "prodalign-ltd.firebaseapp.com",
  projectId: "prodalign-ltd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const form = document.getElementById("companyLoginForm");
const emailEl = document.getElementById("email");
const passEl = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const messageEl = document.getElementById("message");

function showError(text){
  messageEl.textContent = text;
  messageEl.classList.add("show","err");
}

async function getUserProfile(uid){
  const snap = await getDoc(doc(db,"users",uid));
  if(!snap.exists()) return null;

  const data = snap.data();

  return {
    companyCode: String(data.companycode ?? "").trim().toLowerCase(),
    role: String(data.role ?? "admin").trim().toLowerCase(),
    station: String(data.station ?? "").trim().toLowerCase()
  };
}

async function routeUser(user){
  const profile = await getUserProfile(user.uid);

  if(!profile || !profile.companyCode){
    showError("User not assigned to a company.");
    return;
  }

  // ðŸ‘· OPERATOR â†’ Shop Floor Dashboard
  if(profile.role === "operator"){
    if(!profile.station){
      showError("Operator has no station assigned.");
      return;
    }

    window.location.assign(
      `/company/FloorDashboard.html?c=${profile.companyCode}&station=${profile.station}`
    );
    return;
  }

  // ðŸ§‘â€ðŸ’¼ ADMIN â†’ Management Dashboard
  window.location.assign(`/company/?c=${profile.companyCode}`);
}

// Auto redirect if already logged in
onAuthStateChanged(auth,(user)=>{
  if(user){
    routeUser(user);
  }
});

// Login submit
form.addEventListener("submit", async(e)=>{
  e.preventDefault();
  loginBtn.disabled = true;

  try{
    const cred = await signInWithEmailAndPassword(
      auth,
      emailEl.value.trim(),
      passEl.value
    );

    await routeUser(cred.user);
  }
  catch(err){
    showError("Login failed. Check email & password.");
  }
  finally{
    loginBtn.disabled = false;
  }
});
</script>
