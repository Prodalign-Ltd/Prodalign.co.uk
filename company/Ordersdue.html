<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Orders Due</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg: #071826;
      --panel: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.10);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.75);
      --orange: #f57c00;
      --radius: 14px;

      /* JS sets these dynamically */
      --leftCol: 220px;
      --dateCols: 1;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(245,124,0,0.18), transparent 60%),
                  radial-gradient(900px 600px at 120% 0%, rgba(211,47,47,0.12), transparent 55%),
                  linear-gradient(180deg, var(--bg) 0%, #06131e 100%);
      color: var(--text);
      min-height: 100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 18px;
      background: linear-gradient(90deg, rgba(16,44,68,0.95), rgba(9,27,42,0.92));
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      gap: 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width:0;
    }
    .brand img{
      height: 44px;
      max-width: 220px;
      object-fit: contain;
      border-radius: 10px;
      background: rgba(255,255,255,0.06);
      padding: 6px;
      display:none;
      border: 1px solid rgba(245,124,0,0.20);
    }
    .brand .name{
      font-weight: 900;
      font-size: 1.05rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 56vw;
      letter-spacing: 0.2px;
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
    }

    button{
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.08);
      color: #fff;
      cursor: pointer;
      font-weight: 800;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    button:hover{
      background: rgba(255,255,255,0.12);
      border-color: rgba(245,124,0,0.35);
      transform: translateY(-1px);
    }
    .btn-danger{
      border-color: rgba(211,47,47,0.40);
      background: linear-gradient(180deg, rgba(211,47,47,0.18), rgba(255,255,255,0.08));
    }

    .wrap{
      padding: 14px;
      flex: 1;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }

    .panel-header{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), transparent);
    }

    .panel-title{
      font-weight: 900;
      font-size: 0.92rem;
      letter-spacing: 0.2px;
      opacity: 0.95;
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .panel-title .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--orange);
      box-shadow: 0 0 0 4px rgba(245,124,0,0.15);
      display:inline-block;
    }

    .hint{
      color: var(--muted);
      font-weight: 800;
      font-size: 0.9rem;
      line-height: 1.35;
      white-space: nowrap;
    }

    .panel-body{
      padding: 12px;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    /* ===== Grid Table wrapper ===== */
    #gridWrap{
      border:1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      background: rgba(0,0,0,0.18);
      min-height: 0;
      flex: 1;

      overflow-y: auto;
      overflow-x: hidden; /* shrink columns instead of horizontal scroll */
    }

    /* ===== Table layout: fill screen evenly ===== */
    .dueTable{
      width: 100%;
      table-layout: fixed;     /* key */
      border-collapse: collapse;
      font-size: 13px;
    }

    .dueTable th, .dueTable td{
      border-bottom: 1px solid rgba(255,255,255,0.08);
      border-right: 1px solid rgba(255,255,255,0.06);
      padding: 6px 8px;
      vertical-align: middle;
    }

    /* Sticky header */
    .dueTable thead th{
      position: sticky;
      top: 0;
      background: rgba(11,29,42,0.98);
      z-index: 3;
      font-weight: 950;
      text-align: center;
    }

    /* Sticky left header cell */
    .dueTable thead th.leftHead{
      text-align: left;
      position: sticky;
      left: 0;
      z-index: 5;
      background: rgba(11,29,42,0.98);

      width: var(--leftCol);
      min-width: var(--leftCol);
      max-width: var(--leftCol);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 14px;
    }

    /* Sticky row labels */
    .dueTable tbody th{
      position: sticky;
      left: 0;
      z-index: 2;
      background: rgba(0,0,0,0.24);
      font-weight: 950;
      text-align: left;

      width: var(--leftCol);
      min-width: var(--leftCol);
      max-width: var(--leftCol);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 14px;
    }

    /* Date columns share remaining width evenly */
    .dateHead,
    .dueCell{
      width: calc((100% - var(--leftCol)) / var(--dateCols));
      min-width: 0; /* allow shrinking */
      text-align: center;
    }

    /* Vertical dates */
    .dateHead{
      padding: 0;
    }
    .verticalDate{
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      white-space: nowrap;
      font-weight: 900;
      padding: 6px 2px;
      font-size: 12px;
      margin: 0 auto;
    }

    /* Cells */
    .dueCell{
      font-weight: 950;
      height: 26px;
    }
    .dueCell.empty{
      color: rgba(255,255,255,0.18);
      font-weight: 800;
    }
    .dueCell.filled{
      color: #fff;
    }

    /* ===== Today orange line ===== */
    .dateHead.today,
    .dueCell.today{
      border-left: 4px solid #f57c00 !important;
      box-shadow: inset 4px 0 0 rgba(245,124,0,0.30);
    }

    /* ===== Quantity coloring ===== */
    .dueCell.past.filled{ color:#d32f2f !important; }   /* red */
    .dueCell.future.filled{ color:#ffffff !important; } /* white */

    @media (max-width: 980px){
      .brand .name{ max-width: 48vw; }
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <img id="companyLogo" alt="Company Logo" />
      <div class="name" id="companyName">Loading…</div>
    </div>

    <div class="actions">
      <button id="backBtn" type="button">Back</button>
      <button id="logoutBtn" class="btn-danger" type="button">Log out</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title"><span class="dot"></span> Orders Due</div>
        <div class="hint" id="statusText">Reading jobs…</div>
      </div>

      <div class="panel-body">
        <div id="gridWrap"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Firebase config =====
    const firebaseConfig = {
      apiKey: "AIzaSyD-ArzjlwKTZVpsH4ERg7n-MEgzCt6Nzno",
      authDomain: "prodalign-ltd.firebaseapp.com",
      projectId: "prodalign-ltd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Company id from URL (?c=...) =====
    const params = new URLSearchParams(window.location.search);
    const companyId = (params.get("c") || "").trim().toLowerCase();

    // ===== UI refs =====
    const companyLogoEl = document.getElementById("companyLogo");
    const companyNameEl = document.getElementById("companyName");
    const logoutBtn = document.getElementById("logoutBtn");
    const backBtn = document.getElementById("backBtn");
    const gridWrap = document.getElementById("gridWrap");
    const statusText = document.getElementById("statusText");

    if (!companyId) {
      companyNameEl.textContent = "Missing company id (?c=...)";
      statusText.textContent = "Cannot load without ?c=";
      throw new Error("Missing ?c=");
    }

    // ===== Helpers =====
    function dateKeyFromDue(dueAt){
      const d = dueAt?.toDate ? dueAt.toDate() : (dueAt instanceof Date ? dueAt : new Date(dueAt));
      if (!d || Number.isNaN(d.getTime())) return null;

      // LOCAL YYYY-MM-DD
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatHeaderDate(yyyyMmDd){
      // Keep as YYYY-MM-DD (matches key). If you want prettier, ask and we’ll keep key separate.
      return yyyyMmDd;
    }

    function rowLabel(job){
      const part = String(job.itemCode || "").trim().toUpperCase();
      const order = String(job.orderNo || "").trim();
      return `${part} (${order})`;
    }

    function buildGridModel(jobs){
      const dateKeysSet = new Set();
      const rowMap = new Map(); // label -> { label, cells: Map(dateKey->qtySum) }

      for (const j of jobs){
        const dk = dateKeyFromDue(j.dueAt);
        if (!dk) continue;

        const label = rowLabel(j);
        if (!label || label.startsWith("(") || label.startsWith(" (")) continue;

        const qty = Math.max(1, Math.floor(Number(j.qty || 0)));
        if (!Number.isFinite(qty) || qty <= 0) continue;

        dateKeysSet.add(dk);

        if (!rowMap.has(label)) rowMap.set(label, { label, cells: new Map() });

        const prev = rowMap.get(label).cells.get(dk) || 0;
        rowMap.get(label).cells.set(dk, prev + qty);
      }

      const dateKeys = Array.from(dateKeysSet).sort();
      const rows = Array.from(rowMap.values())
  .map(r => {
    const firstDate = Array.from(r.cells.keys()).sort()[0];
    return { ...r, firstDate };
  })
  .sort((a, b) => a.firstDate.localeCompare(b.firstDate));
      return { dateKeys, rows };
    }

    function todayKeyLocal(){
      const now = new Date();
      return (
        now.getFullYear() + "-" +
        String(now.getMonth() + 1).padStart(2,"0") + "-" +
        String(now.getDate()).padStart(2,"0")
      );
    }

    function renderGrid({ dateKeys, rows }){
      const todayKey = todayKeyLocal();

      if (!dateKeys.length || !rows.length){
        gridWrap.innerHTML = `
          <div style="padding:12px;color:rgba(255,255,255,0.7);font-weight:900;">
            No jobs with due dates found.
          </div>`;
        return;
      }

      // evenly-distributed columns
      gridWrap.style.setProperty("--dateCols", String(dateKeys.length || 1));

      const thead = `
        <table class="dueTable">
          <thead>
            <tr>
              <th class="leftHead">Part (Order)</th>
              ${dateKeys.map(dk => {
                const isToday = dk === todayKey;
                return `
                  <th class="dateHead ${isToday ? "today" : ""}">
                    <div class="verticalDate">${formatHeaderDate(dk)}</div>
                  </th>
                `;
              }).join("")}
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => {
              const tds = dateKeys.map(dk => {
                const v = r.cells.get(dk);
                const isToday = dk === todayKey;
                const isPast = dk < todayKey; // works for YYYY-MM-DD
                if (!v){
                  return `<td class="dueCell empty ${isToday ? "today" : ""}"></td>`;
                }
                const colorClass = isPast ? "past" : "future";
                return `<td class="dueCell filled ${colorClass} ${isToday ? "today" : ""}">${v}</td>`;
              }).join("");

              return `
                <tr>
                  <th title="${r.label}">${r.label}</th>
                  ${tds}
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      gridWrap.innerHTML = thead;

      // Measure longest row label -> set left col width (clamped)
      requestAnimationFrame(() => {
        const rowHeads = gridWrap.querySelectorAll(".dueTable tbody th");
        let max = 0;
        rowHeads.forEach(th => { max = Math.max(max, th.scrollWidth); });

        const minPx = 150;
        const maxPx = Math.min(420, Math.floor(window.innerWidth * 0.45)); // <=45% of screen
        const leftPx = Math.max(minPx, Math.min(max, maxPx));
        gridWrap.style.setProperty("--leftCol", `${leftPx}px`);
      });
    }

    // Recalc left column on resize
    window.addEventListener("resize", () => {
      const table = gridWrap.querySelector(".dueTable");
      if (!table) return;

      const rowHeads = gridWrap.querySelectorAll(".dueTable tbody th");
      let max = 0;
      rowHeads.forEach(th => { max = Math.max(max, th.scrollWidth); });

      const minPx = 150;
      const maxPx = Math.min(420, Math.floor(window.innerWidth * 0.45));
      const leftPx = Math.max(minPx, Math.min(max, maxPx));
      gridWrap.style.setProperty("--leftCol", `${leftPx}px`);
    });

    // ===== Branding + auth enforcement (same pattern as your other pages) =====
    async function loadCompanyBranding(companyId) {
      const snap = await getDoc(doc(db, "companies", companyId));
      if (!snap.exists()) {
        companyNameEl.textContent = `Company '${companyId}' not found`;
        return;
      }

      const company = snap.data() || {};
      const name = company.displayname || "Company";
      const logoUrl = company.Logourl || "";

      companyNameEl.textContent = name;
      if (logoUrl) {
        companyLogoEl.src = logoUrl;
        companyLogoEl.style.display = "block";
      }

      document.title = `${name} | Orders Due`;
    }

    async function enforceUserCompany(user, companyId) {
      const userSnap = await getDoc(doc(db, "users", user.uid));
      if (!userSnap.exists()) throw new Error("User profile missing (users/{uid}).");

      const data = userSnap.data() || {};
      const userCompany = String(data.companycode ?? data.companyCode ?? "").trim().toLowerCase();

      if (!userCompany) throw new Error("User profile missing companycode.");
      if (userCompany !== companyId) throw new Error("Access denied for this company.");
      return true;
    }

    function watchJobs(companyId){
      const jobsRef = collection(db, "companies", companyId, "jobs");
      const qy = query(jobsRef, orderBy("dueAt", "asc"));

      onSnapshot(qy, (snap) => {
        const jobs = [];
        snap.forEach(ds => jobs.push({ id: ds.id, ...ds.data() }));

        const model = buildGridModel(jobs);
        renderGrid(model);

        statusText.textContent = `Jobs: ${jobs.length}`;
      }, (err) => {
        console.error(err);
        statusText.textContent = "Error loading jobs";
        gridWrap.innerHTML = `
          <div style="padding:12px;color:#ffb4b4;font-weight:900;">
            Error loading jobs: ${err.message}
          </div>`;
      });
    }

    // ===== Buttons =====
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
    });

    backBtn.addEventListener("click", () => {
      window.location.assign(`./index.html?c=${encodeURIComponent(companyId)}`);
    });

    // ===== Start =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
        return;
      }

      try{
        await enforceUserCompany(user, companyId);
        await loadCompanyBranding(companyId);
        watchJobs(companyId);
      } catch (err){
        console.error(err);
        try { await signOut(auth); } catch {}
        window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
      }
    });
  </script>
</body>
</html>
