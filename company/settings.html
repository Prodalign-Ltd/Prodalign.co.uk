<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Company Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg: #071826;
      --bg-2:#0b2235;
      --panel: rgba(255,255,255,0.06);
      --panel-2: rgba(255,255,255,0.04);
      --border: rgba(255,255,255,0.10);
      --border-strong: rgba(245,124,0,0.35);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.78);

      --blue: #0b1d2a;
      --orange: #f57c00;
      --red: #d32f2f;

      --radius: 14px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(245,124,0,0.18), transparent 60%),
                  radial-gradient(900px 600px at 120% 0%, rgba(211,47,47,0.12), transparent 55%),
                  linear-gradient(180deg, var(--bg) 0%, #06131e 100%);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      background: linear-gradient(90deg, rgba(16,44,68,0.95), rgba(9,27,42,0.92));
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .brand img {
      height: 44px;
      max-width: 220px;
      object-fit: contain;
      border-radius: 10px;
      background: rgba(255,255,255,0.06);
      padding: 6px;
      display: none;
      border: 1px solid rgba(245,124,0,0.20);
    }

    .brand .name {
      font-weight: 900;
      font-size: 1.05rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 56vw;
      letter-spacing: 0.2px;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    button {
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.08);
      color: #fff;
      cursor: pointer;
      font-weight: 800;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    button:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(245,124,0,0.35);
      transform: translateY(-1px);
    }
    button:disabled{
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-primary{
      border-color: rgba(245,124,0,0.45);
      background: linear-gradient(180deg, rgba(245,124,0,0.22), rgba(245,124,0,0.10));
    }
    .btn-danger{
      border-color: rgba(211,47,47,0.40);
      background: linear-gradient(180deg, rgba(211,47,47,0.18), rgba(255,255,255,0.08));
    }

    .dashboard {
      height: calc(100vh - 73px);
      padding: 14px;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .panel-header{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), transparent);
    }

    .panel-title{
      font-weight: 900;
      font-size: 0.92rem;
      letter-spacing: 0.2px;
      opacity: 0.95;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--orange);
      box-shadow: 0 0 0 4px rgba(245,124,0,0.15);
      display: inline-block;
    }

    .panel-body{ padding: 12px; }

    .sidebar {
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 14px;
      min-height: 0;
    }

    .findbox .panel-body{ padding: 10px 12px 12px; }

    .field-label{
      font-weight: 900;
      font-size: 0.9rem;
      margin: 2px 0 8px;
      opacity: 0.95;
    }

    input[type="search"]{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      outline: none;
    }
    input[type="search"]:focus{
      border-color: rgba(245,124,0,0.55);
      box-shadow: 0 0 0 4px rgba(245,124,0,0.12);
    }

    .tree {
      min-height: 0;
      display: grid;
      grid-template-rows: auto 1fr;
    }
    .tree .panel-body{
      padding: 10px 10px 12px;
      overflow: auto;
    }

    /* Tree row now supports a delete button */
    .tree-item{
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
      margin-bottom: 10px;

      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;

      user-select:none;
    }
    .tree-item:hover{
      border-color: rgba(245,124,0,0.28);
      background: rgba(255,255,255,0.06);
    }
    .tree-item .left{ min-width:0; cursor:pointer; flex:1; }
    .tree-item strong{ display:block; font-size: 0.92rem; }
    .tree-item .muted{ opacity: 0.75; font-size: 0.86rem; margin-top: 6px; }

    .tree-item .del{
      border: 1px solid rgba(211,47,47,0.45);
      background: rgba(211,47,47,0.12);
      padding: 8px 10px;
      border-radius: 10px;
      font-weight: 950;
      cursor: pointer;
      line-height: 1;
      flex: 0 0 auto;
    }
    .tree-item .del:hover{
      background: rgba(211,47,47,0.20);
      border-color: rgba(211,47,47,0.65);
      transform:none;
    }

    .order-ready {
      border-style: dashed;
      border-width: 2px;
      border-color: rgba(211,47,47,0.45);
      background: radial-gradient(700px 250px at 50% 0%, rgba(211,47,47,0.14), transparent 60%),
                  rgba(255,255,255,0.04);
    }
    .order-ready .panel-body{
      text-align: center;
      padding: 14px 12px 16px;
    }
    .order-ready .hint{
      margin-top: 6px;
      color: var(--muted);
      font-size: 0.86rem;
      line-height: 1.35;
    }

    .main {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 14px;
      min-height: 0;
    }

    .topbar {
      padding: 10px 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .topbar .center-dot{
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.40);
      opacity: 0.8;
    }

    .mainTop {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      min-height: 0;
    }

    .containsRow{
      display: grid;
      grid-template-columns: 110px 1fr 1fr;
      gap: 10px;
      padding: 10px;
    }
    .idCard{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 96px;
    }
    .idCard .id{
      font-weight: 950;
      letter-spacing: 0.3px;
    }
    .idCard .badge{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      color: var(--muted);
    }
    .idCard .badge::before{
      content:"";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--orange);
      box-shadow: 0 0 0 4px rgba(245,124,0,0.12);
    }

    .miniPanel{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      min-height: 96px;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
    }
    .miniPanel .miniHeader{
      padding: 10px 10px 8px;
      font-weight: 950;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(245,124,0,0.10), transparent);
    }
    .miniPanel .miniBody{
      padding: 10px;
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.35;
    }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      margin: 6px 6px 0 0;
      color: #fff;
      font-weight: 800;
      font-size: 0.86rem;
    }
    .pill::before{
      content:"";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--orange);
    }
    .pill.red::before{ background: var(--red); }

    .details {
      min-height: 0;
      display: grid;
      grid-template-rows: auto 1fr;
    }
    .details .panel-body{
      min-height: 0;
      overflow: auto;
    }
    .detailsGrid{
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 14px;
      align-items: start;
    }
    .card {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      padding: 12px;
    }
    .kv{
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      color: var(--muted);
      font-size: 0.92rem;
    }
    .kv b{ color: #fff; }

    .emptyHint{
      height: 100%;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.14);
      display: grid;
      place-items: center;
      padding: 20px;
      color: rgba(255,255,255,0.65);
      font-weight: 800;
      text-align: center;
    }

    /* ===== MODAL SYSTEM ===== */
    .modal {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
      z-index: 50;
    }
    .modal.open { opacity: 1; pointer-events: auto; }

    .modal-card {
      width: 440px;
      max-width: 92vw;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(11,29,42,0.98), rgba(6,19,30,0.98));
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      animation: modalPop 160ms ease;
    }
    @keyframes modalPop {
      from { transform: scale(.96); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .modal-title { font-weight: 900; }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      opacity: 0.7;
      padding: 6px 10px;
      color: #fff;
    }
    .modal-close:hover { opacity: 1; }

    .modal-body {
      padding: 16px;
      display: grid;
      gap: 14px;
    }

    .form-group { display: grid; gap: 6px; }
    .form-group label {
      font-weight: 800;
      font-size: 0.85rem;
      opacity: 0.9;
    }
    .form-group input,
    .form-group select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.3);
      color: white;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: rgba(245,124,0,0.7);
      box-shadow: 0 0 0 3px rgba(245,124,0,0.15);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .modal-status{
      margin-right: auto;
      font-weight: 800;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.75);
      min-height: 1.2em;
    }

    @media (max-width: 980px) {
      .dashboard{
        grid-template-columns: 1fr;
        height: auto;
      }
      .detailsGrid{ grid-template-columns: 1fr; }
      .containsRow{ grid-template-columns: 1fr; }
      .brand .name{ max-width: 48vw; }
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <img id="companyLogo" alt="Company Logo" />
    <div class="name" id="companyName">Loading...</div>
  </div>

  <div class="actions">
    <button id="addMemberBtn" class="btn-primary" type="button">Add member</button>
    <button id="backBtn" type="button">Back</button>
    <button id="logoutBtn" class="btn-danger" type="button">Log out</button>
  </div>
</header>

<div class="dashboard">
  <!-- LEFT -->
  <div class="sidebar">
    <div class="panel findbox">
      <div class="panel-body">
        <div class="field-label">Find</div>
        <input id="findInput" type="search" placeholder="Search parts / orders / ops…" />
      </div>
    </div>

    <div class="panel tree">
      <div class="panel-header">
        <div class="panel-title"><span class="dot"></span> Tree of Items</div>
      </div>
      <div class="panel-body">
        <div id="treeList"></div>
      </div>
    </div>

    <div class="panel order-ready" id="dropzone">
      <div class="panel-body">
        <div class="panel-title" style="justify-content:center;">
          <span class="dot" style="background:var(--red); box-shadow:0 0 0 4px rgba(211,47,47,0.12)"></span>
          Order Ready?
        </div>
        <div class="hint">
          (Drag &amp; drop items; opens pop-up to fill quantity, order number, etc.)
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="main">
    <div class="topbar">
      <button id="newItemBtn" class="btn-primary" type="button">New Item</button>
      <div class="center-dot" aria-hidden="true"></div>
      <div style="display:flex; gap:10px; align-items:center; color:var(--muted); font-weight:800;">
        <span style="opacity:.9;">Company Workspace</span>
      </div>
    </div>

    <div class="panel mainTop">
      <div class="containsRow">
        <div class="idCard">
          <div class="id" id="activeItemId">—</div>
          <div class="badge">Active</div>
        </div>

        <div class="miniPanel">
          <div class="miniHeader">Contains Items:</div>
          <div class="miniBody" id="containsItems"></div>
        </div>

        <div class="miniPanel">
          <div class="miniHeader">Contains Operations:</div>
          <div class="miniBody" id="containsOps"></div>
        </div>
      </div>
    </div>

    <div class="panel details" id="mainArea">
      <div class="panel-header">
        <div class="panel-title"><span class="dot"></span> Item Data</div>
      </div>
      <div class="panel-body">
        <div class="detailsGrid">
          <div class="card">
            <div class="kv">
              <div><b>Item:</b> <span id="detailItem">—</span></div>
              <div><b>Item Cost:</b> <span id="detailCost">—</span></div>
              <div><b>Operation Time:</b> <span id="detailTime">—</span></div>
              <div><b>Description:</b> <span id="detailEtc">—</span></div>
            </div>
          </div>

          <div class="emptyHint">
            Click an item in the Tree to view it here.<br/>
            Use “New Item” to create your first item.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Add Member Modal -->
<div id="addMemberModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="addMemberTitle">
    <div class="modal-header">
      <div class="modal-title" id="addMemberTitle">Add member</div>
      <button class="modal-close" id="closeAddMemberModal" type="button">✕</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="memberEmail">Email</label>
        <input id="memberEmail" type="email" placeholder="name@company.com" autocomplete="email" />
      </div>

      <div class="form-group">
        <label for="memberRole">Role</label>
        <select id="memberRole">
          <option value="member" selected>Member</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div style="color: rgba(255,255,255,0.72); font-weight: 800; font-size: 0.9rem; line-height: 1.35;">
        This calls a Firebase Cloud Function named <b>createCompanyMember</b>.
      </div>
    </div>

    <div class="modal-footer">
      <div class="modal-status" id="addMemberStatus"></div>
      <button id="cancelAddMember" type="button">Cancel</button>
      <button class="btn-primary" id="createMemberBtn" type="button">Create member</button>
    </div>
  </div>
</div>

<!-- ✅ New Item Modal -->
<div id="newItemModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="newItemTitle">
    <div class="modal-header">
      <div class="modal-title" id="newItemTitle">Create New Item</div>
      <button class="modal-close" id="closeNewItemModal" type="button">✕</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="newItemCode">Item Code</label>
        <input type="text" id="newItemCode" placeholder="e.g. P40000" autocomplete="off">
      </div>

      <div class="form-group">
        <label for="newItemDescription">Description</label>
        <input type="text" id="newItemDescription" placeholder="Item description" autocomplete="off">
      </div>

      <div class="form-group">
        <label for="newItemCost">Base Cost</label>
        <input type="number" id="newItemCost" placeholder="0.00" inputmode="decimal">
      </div>
    </div>

    <div class="modal-footer">
      <div class="modal-status" id="newItemStatus"></div>
      <button id="cancelNewItem" type="button">Cancel</button>
      <button class="btn-primary" id="saveNewItem" type="button">Create Item</button>
    </div>
  </div>
</div>

<!-- ✅ Delete Confirm Modal -->
<div id="deleteItemModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="deleteItemTitle">
    <div class="modal-header">
      <div class="modal-title" id="deleteItemTitle">Delete item</div>
      <button class="modal-close" id="closeDeleteItemModal" type="button">✕</button>
    </div>

    <div class="modal-body">
      <div style="font-weight:900; line-height:1.35;">
        This will permanently delete:
        <span id="deleteItemName" style="color:var(--orange);"></span>
      </div>

      <div style="color: rgba(255,255,255,0.72); font-weight:800; line-height:1.35;">
        Type <b>DELETE</b> to confirm.
      </div>

      <div class="form-group">
        <label for="deleteConfirmText">Confirmation</label>
        <input id="deleteConfirmText" type="text" placeholder="Type DELETE" autocomplete="off" />
      </div>
    </div>

    <div class="modal-footer">
      <div class="modal-status" id="deleteStatus"></div>
      <button id="cancelDeleteItem" type="button">Cancel</button>
      <button class="btn-danger" id="confirmDeleteItem" type="button" disabled>Delete</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc,
    collection, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD-ArzjlwKTZVpsH4ERg7n-MEgzCt6Nzno",
    authDomain: "prodalign-ltd.firebaseapp.com",
    projectId: "prodalign-ltd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const functions = getFunctions(app);

  // URL company id
  const params = new URLSearchParams(window.location.search);
  const companyId = (params.get("c") || "").trim().toLowerCase();

  // Header UI
  const companyLogoEl = document.getElementById("companyLogo");
  const companyNameEl = document.getElementById("companyName");
  const logoutBtn = document.getElementById("logoutBtn");
  const backBtn = document.getElementById("backBtn");

  // Topbar
  const newItemBtn = document.getElementById("newItemBtn");
  const findInput = document.getElementById("findInput");

  // Tree + active UI
  const treeListEl = document.getElementById("treeList");
  const activeItemIdEl = document.getElementById("activeItemId");
  const containsItemsEl = document.getElementById("containsItems");
  const containsOpsEl = document.getElementById("containsOps");

  // Detail UI
  const detailItem = document.getElementById("detailItem");
  const detailCost = document.getElementById("detailCost");
  const detailTime = document.getElementById("detailTime");
  const detailEtc = document.getElementById("detailEtc");

  // Add member UI
  const addMemberBtn = document.getElementById("addMemberBtn");
  const addMemberModal = document.getElementById("addMemberModal");
  const closeAddMemberModal = document.getElementById("closeAddMemberModal");
  const cancelAddMember = document.getElementById("cancelAddMember");
  const createMemberBtn = document.getElementById("createMemberBtn");
  const memberEmail = document.getElementById("memberEmail");
  const memberRole = document.getElementById("memberRole");
  const addMemberStatus = document.getElementById("addMemberStatus");

  // New item modal UI
  const newItemModal = document.getElementById("newItemModal");
  const closeNewItemModal = document.getElementById("closeNewItemModal");
  const cancelNewItem = document.getElementById("cancelNewItem");
  const saveNewItem = document.getElementById("saveNewItem");
  const newItemCode = document.getElementById("newItemCode");
  const newItemDescription = document.getElementById("newItemDescription");
  const newItemCost = document.getElementById("newItemCost");
  const newItemStatus = document.getElementById("newItemStatus");

  // Delete modal UI
  const deleteItemModal = document.getElementById("deleteItemModal");
  const closeDeleteItemModal = document.getElementById("closeDeleteItemModal");
  const cancelDeleteItem = document.getElementById("cancelDeleteItem");
  const confirmDeleteItem = document.getElementById("confirmDeleteItem");
  const deleteConfirmText = document.getElementById("deleteConfirmText");
  const deleteItemName = document.getElementById("deleteItemName");
  const deleteStatus = document.getElementById("deleteStatus");
  let pendingDeleteCode = null;

  // ✅ Track current active item (for contains-drop updates)
  let activeItemCode = null;
  let activeItemData = null;

  if (!companyId) {
    companyNameEl.textContent = "Missing company id (?c=...)";
    throw new Error("Missing ?c=");
  }

  // ---------- UI helpers ----------
  function renderPills(container, values, isRed, emptyText){
    container.innerHTML = "";
    if (!Array.isArray(values) || values.length === 0) {
      container.style.color = "rgba(255,255,255,0.65)";
      container.textContent = emptyText;
      return;
    }
    container.style.color = "";
    values.forEach(v => {
      const span = document.createElement("span");
      span.className = `pill${isRed ? " red" : ""}`;
      span.textContent = v;
      container.appendChild(span);
    });
  }

  function setActiveItem(item){
    const code = item?.code || "—";

    activeItemCode = (code && code !== "—") ? String(code).trim().toUpperCase() : null;
    activeItemData = item || null;

    activeItemIdEl.textContent = code;

    renderPills(containsItemsEl, item?.contains, false, "No contained items");
    renderPills(containsOpsEl, item?.operations, true, "No operations");

    detailItem.textContent = code;
    detailCost.textContent = (item?.baseCost ?? "—");
    detailTime.textContent = (item?.operationTime ?? "—");
    detailEtc.textContent = (item?.description ?? "—");
  }

  // ---------- ✅ Drag & drop: Contains Items ----------
  function setContainsDropActive(isActive) {
    const panel = containsItemsEl.closest(".miniPanel");
    if (!panel) return;
    panel.style.borderColor = isActive ? "rgba(245,124,0,0.65)" : "rgba(255,255,255,0.10)";
    panel.style.boxShadow = isActive ? "0 0 0 4px rgba(245,124,0,0.12)" : "none";
  }

  async function addContainedItemToActiveItem(containedCode) {
    if (!activeItemCode) {
      alert("Select an item first (the one that will contain the part).");
      return;
    }

    const child = String(containedCode || "").trim().toUpperCase();
    if (!child) return;

    // prevent adding itself
    if (child === activeItemCode) {
      alert("An item cannot contain itself.");
      return;
    }

    const parentRef = doc(db, "companies", companyId, "items", activeItemCode);

    const snap = await getDoc(parentRef);
    if (!snap.exists()) throw new Error(`Active item '${activeItemCode}' no longer exists.`);

    const data = snap.data() || {};
    const current = Array.isArray(data.contains) ? data.contains : [];

    // prevent duplicates
    if (current.includes(child)) return;

    await setDoc(parentRef, {
      contains: [...current, child],
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  // Make the "Contains Items" box accept drops
  containsItemsEl.addEventListener("dragenter", (e) => {
    e.preventDefault();
    setContainsDropActive(true);
  });

  containsItemsEl.addEventListener("dragover", (e) => {
    e.preventDefault(); // REQUIRED for drop
    e.dataTransfer.dropEffect = "copy";
  });

  containsItemsEl.addEventListener("dragleave", (e) => {
    if (e.relatedTarget && containsItemsEl.contains(e.relatedTarget)) return;
    setContainsDropActive(false);
  });

  containsItemsEl.addEventListener("drop", async (e) => {
    e.preventDefault();
    setContainsDropActive(false);

    const droppedCode = e.dataTransfer.getData("text/plain");
    try {
      await addContainedItemToActiveItem(droppedCode);
    } catch (err) {
      console.error(err);
      alert(err?.message || "Failed to add contained item.");
    }
  });

  // ---------- Firestore: live tree ----------
  function watchItems(companyId){
    const itemsRef = collection(db, "companies", companyId, "items");

    onSnapshot(itemsRef, (snap) => {
      treeListEl.innerHTML = "";

      if (snap.empty) {
        treeListEl.style.color = "rgba(255,255,255,0.65)";
        treeListEl.textContent = "No items yet. Click “New Item” to create one.";
        setActiveItem(null);
        return;
      }

      treeListEl.style.color = "";

      let first = null;

      snap.forEach((d) => {
        const item = d.data();
        const code = (item.code || d.id || "").toUpperCase();
        if (!first) first = { ...item, code };

        const row = document.createElement("div");
        row.className = "tree-item";

        // ✅ draggable from tree
        row.draggable = true;
        row.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", code);
          e.dataTransfer.effectAllowed = "copy";
        });

        const left = document.createElement("div");
        left.className = "left";
        left.innerHTML = `
          <strong>${code}</strong>
          <div class="muted">${item.description || "—"}</div>
        `;

        left.addEventListener("click", () => {
          setActiveItem({ ...item, code });
        });

        const del = document.createElement("button");
        del.className = "del";
        del.type = "button";
        del.textContent = "Delete";
        del.addEventListener("click", (e) => {
          e.stopPropagation();
          openDeleteModal(code);
        });

        row.appendChild(left);
        row.appendChild(del);
        treeListEl.appendChild(row);
      });

      if (activeItemIdEl.textContent === "—" && first) setActiveItem(first);
    }, (err) => {
      console.error("Tree listener error:", err);
      treeListEl.innerHTML = `<div style="color:#ffb4b4;font-weight:900;">
        Error loading items: ${err.message}
      </div>`;
    });
  }

  // ---------- Branding + auth ----------
  async function loadCompanyBranding(companyId) {
    const snap = await getDoc(doc(db, "companies", companyId));
    if (!snap.exists()) {
      companyNameEl.textContent = `Company '${companyId}' not found`;
      return;
    }

    const company = snap.data();
    const name = company.displayname || "Company";
    const logoUrl = company.Logourl || "";

    companyNameEl.textContent = name;
    if (logoUrl) {
      companyLogoEl.src = logoUrl;
      companyLogoEl.style.display = "block";
    }

    document.title = `${name} | Settings`;
  }

  async function enforceUserCompany(user, companyId) {
    const userSnap = await getDoc(doc(db, "users", user.uid));
    if (!userSnap.exists()) throw new Error("User profile missing (users/{uid}).");

    const data = userSnap.data();
    const userCompany = String(data.companycode ?? data.companyCode ?? "").trim().toLowerCase();

    if (!userCompany) throw new Error("User profile missing companycode.");
    if (userCompany !== companyId) throw new Error("Access denied for this company.");
    return true;
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
      return;
    }

    try {
      await enforceUserCompany(user, companyId);
      await loadCompanyBranding(companyId);
      watchItems(companyId);
    } catch (err) {
      console.error(err);
      try { await signOut(auth); } catch {}
      window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
    }
  });

  // ---------- Navigation ----------
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
  });

  backBtn.addEventListener("click", () => {
    window.location.assign(`./index.html?c=${encodeURIComponent(companyId)}`);
  });

  // ---------- New Item modal ----------
  function openNewItemModal() {
    newItemStatus.textContent = "";
    newItemCode.value = "";
    newItemDescription.value = "";
    newItemCost.value = "";
    newItemModal.classList.add("open");
    newItemModal.setAttribute("aria-hidden", "false");
    setTimeout(() => newItemCode.focus(), 0);
  }
  function closeNewItemModalFn() {
    newItemModal.classList.remove("open");
    newItemModal.setAttribute("aria-hidden", "true");
  }

  newItemBtn.addEventListener("click", openNewItemModal);
  closeNewItemModal.addEventListener("click", closeNewItemModalFn);
  cancelNewItem.addEventListener("click", closeNewItemModalFn);
  newItemModal.addEventListener("click", (e) => {
    if (e.target === newItemModal) closeNewItemModalFn();
  });

  saveNewItem.addEventListener("click", async () => {
    const code = String(newItemCode.value || "").trim().toUpperCase();
    const description = String(newItemDescription.value || "").trim();
    const baseCost = Number(newItemCost.value || 0);

    if (!code) {
      newItemStatus.textContent = "Item code is required.";
      return;
    }

    saveNewItem.disabled = true;
    newItemStatus.textContent = "Saving…";

    try {
      const itemRef = doc(db, "companies", companyId, "items", code);

      const existing = await getDoc(itemRef);
      if (existing.exists()) {
        newItemStatus.textContent = `${code} already exists.`;
        return;
      }

      await setDoc(itemRef, {
        code,
        description,
        baseCost: Number.isFinite(baseCost) ? baseCost : 0,
        contains: [],
        operations: [],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      newItemStatus.textContent = "Saved!";
      setTimeout(closeNewItemModalFn, 350);
    } catch (err) {
      console.error(err);
      newItemStatus.textContent = err?.message || "Failed to save item.";
    } finally {
      saveNewItem.disabled = false;
    }
  });

  // ---------- Delete modal ----------
  function openDeleteModal(code){
    pendingDeleteCode = code;
    deleteItemName.textContent = code;
    deleteConfirmText.value = "";
    deleteStatus.textContent = "";
    confirmDeleteItem.disabled = true;

    deleteItemModal.classList.add("open");
    deleteItemModal.setAttribute("aria-hidden", "false");
    setTimeout(() => deleteConfirmText.focus(), 0);
  }

  function closeDeleteModal(){
    deleteItemModal.classList.remove("open");
    deleteItemModal.setAttribute("aria-hidden", "true");
    pendingDeleteCode = null;
  }

  closeDeleteItemModal.addEventListener("click", closeDeleteModal);
  cancelDeleteItem.addEventListener("click", closeDeleteModal);
  deleteItemModal.addEventListener("click", (e) => {
    if (e.target === deleteItemModal) closeDeleteModal();
  });

  deleteConfirmText.addEventListener("input", () => {
    confirmDeleteItem.disabled = deleteConfirmText.value.trim().toUpperCase() !== "DELETE";
  });

  confirmDeleteItem.addEventListener("click", async () => {
    if (!pendingDeleteCode) return;
    if (deleteConfirmText.value.trim().toUpperCase() !== "DELETE") return;

    confirmDeleteItem.disabled = true;
    deleteStatus.textContent = "Deleting…";

    try {
      await deleteDoc(doc(db, "companies", companyId, "items", pendingDeleteCode));
      deleteStatus.textContent = "Deleted.";
      setTimeout(closeDeleteModal, 250);
    } catch (err) {
      console.error(err);
      deleteStatus.textContent = err?.message || "Delete failed.";
      confirmDeleteItem.disabled = false;
    }
  });

  // ---------- Add member modal ----------
  function openAddMemberModal() {
    addMemberStatus.textContent = "";
    memberEmail.value = "";
    memberRole.value = "member";
    addMemberModal.classList.add("open");
    addMemberModal.setAttribute("aria-hidden", "false");
    setTimeout(() => memberEmail.focus(), 0);
  }
  function closeAddMemberModalFn() {
    addMemberModal.classList.remove("open");
    addMemberModal.setAttribute("aria-hidden", "true");
  }

  addMemberBtn.addEventListener("click", openAddMemberModal);
  closeAddMemberModal.addEventListener("click", closeAddMemberModalFn);
  cancelAddMember.addEventListener("click", closeAddMemberModalFn);
  addMemberModal.addEventListener("click", (e) => {
    if (e.target === addMemberModal) closeAddMemberModalFn();
  });

  async function callCreateCompanyMember(email, role) {
    const fn = httpsCallable(functions, "createCompanyMember");
    const res = await fn({ companyId, email, role });
    return res.data;
  }

  createMemberBtn.addEventListener("click", async () => {
    const email = memberEmail.value.trim().toLowerCase();
    const role = memberRole.value === "admin" ? "admin" : "member";

    if (!email || !email.includes("@")) {
      addMemberStatus.textContent = "Enter a valid email.";
      return;
    }

    createMemberBtn.disabled = true;
    addMemberStatus.textContent = "Creating member…";

    try {
      const data = await callCreateCompanyMember(email, role);
      addMemberStatus.textContent = `Member added: ${data.email || email}`;
      setTimeout(closeAddMemberModalFn, 800);
    } catch (err) {
      console.error(err);
      addMemberStatus.textContent =
        err?.message || "Could not create member. (Have you deployed the Cloud Function?)";
    } finally {
      createMemberBtn.disabled = false;
    }
  });

  // ---------- ESC closes topmost modal ----------
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;

    if (deleteItemModal.classList.contains("open")) closeDeleteModal();
    else if (addMemberModal.classList.contains("open")) closeAddMemberModalFn();
    else if (newItemModal.classList.contains("open")) closeNewItemModalFn();
  });

  // Find (still placeholder)
  findInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      alert(`Find: ${findInput.value}\n(wire up search later)`);
    }
  });
</script>
</body>
</html>
