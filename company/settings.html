<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Company Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg: #071826;
      --bg-2:#0b2235;
      --panel: rgba(255,255,255,0.06);
      --panel-2: rgba(255,255,255,0.04);
      --border: rgba(255,255,255,0.10);
      --border-strong: rgba(245,124,0,0.35);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.78);

      --blue: #0b1d2a;
      --orange: #f57c00;
      --red: #d32f2f;

      --radius: 14px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(245,124,0,0.18), transparent 60%),
                  radial-gradient(900px 600px at 120% 0%, rgba(211,47,47,0.12), transparent 55%),
                  linear-gradient(180deg, var(--bg) 0%, #06131e 100%);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      background: linear-gradient(90deg, rgba(16,44,68,0.95), rgba(9,27,42,0.92));
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .brand img {
      height: 44px;
      max-width: 220px;
      object-fit: contain;
      border-radius: 10px;
      background: rgba(255,255,255,0.06);
      padding: 6px;
      display: none;
      border: 1px solid rgba(245,124,0,0.20);
    }

    .brand .name {
      font-weight: 900;
      font-size: 1.05rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 56vw;
      letter-spacing: 0.2px;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    button {
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.08);
      color: #fff;
      cursor: pointer;
      font-weight: 800;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    button:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(245,124,0,0.35);
      transform: translateY(-1px);
    }
    button:disabled{
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-primary{
      border-color: rgba(245,124,0,0.45);
      background: linear-gradient(180deg, rgba(245,124,0,0.22), rgba(245,124,0,0.10));
    }
    .btn-danger{
      border-color: rgba(211,47,47,0.40);
      background: linear-gradient(180deg, rgba(211,47,47,0.18), rgba(255,255,255,0.08));
    }

    .dashboard {
      height: calc(100vh - 73px);
      padding: 14px;
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 14px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .panel-header{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), transparent);
    }

    .panel-title{
      font-weight: 900;
      font-size: 0.92rem;
      letter-spacing: 0.2px;
      opacity: 0.95;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--orange);
      box-shadow: 0 0 0 4px rgba(245,124,0,0.15);
      display: inline-block;
    }

    /* ===== TREE HEADER GRID (locks toggle right) ===== */
    .treeHeader{
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .treeHeaderTitle{
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .treeToggle{
      display: inline-flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 6px;
      max-width: 100%;
    }

    .treeTab{
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      font-weight: 900;
      cursor: pointer;
      transform: none !important;
    }

    .treeTab:hover{
      border-color: rgba(245,124,0,0.35);
      background: rgba(255,255,255,0.10);
    }

    .treeTab.active{
      border-color: rgba(245,124,0,0.55);
      background: linear-gradient(180deg, rgba(245,124,0,0.20), rgba(245,124,0,0.08));
    }

    .panel-body{ padding: 12px; }

    .sidebar {
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 14px;
      min-height: 0;
    }

    .findbox .panel-body{ padding: 10px 12px 12px; }

    .field-label{
      font-weight: 900;
      font-size: 0.9rem;
      margin: 2px 0 8px;
      opacity: 0.95;
    }

    input[type="search"]{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      outline: none;
    }
    input[type="search"]:focus{
      border-color: rgba(245,124,0,0.55);
      box-shadow: 0 0 0 4px rgba(245,124,0,0.12);
    }

    .tree {
      min-height: 0;
      display: grid;
      grid-template-rows: auto 1fr;
    }
    .tree .panel-body{
      padding: 10px 10px 12px;
      overflow: auto;
      overflow-x: hidden;
    }

    .tree-item{
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
      margin-bottom: 10px;

      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;

      user-select:none;
    }
    .tree-item:hover{
      border-color: rgba(245,124,0,0.28);
      background: rgba(255,255,255,0.06);
    }
    .tree-item .left{
      min-width: 0;
      cursor: pointer;
      flex: 1;
    }
    .tree-item strong{ display:block; font-size: 0.92rem; }
    .tree-item .muted{
      opacity: 0.75;
      font-size: 0.86rem;
      margin-top: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .order-ready {
      border-style: dashed;
      border-width: 2px;
      border-color: rgba(211,47,47,0.45);
      background: radial-gradient(700px 250px at 50% 0%, rgba(211,47,47,0.14), transparent 60%),
                  rgba(255,255,255,0.04);
    }
    .order-ready .panel-body{
      text-align: center;
      padding: 14px 12px 16px;
    }
    .order-ready .hint{
      margin-top: 6px;
      color: var(--muted);
      font-size: 0.86rem;
      line-height: 1.35;
    }

    .main {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 14px;
      min-height: 0;
    }

    .topbar {
      padding: 10px 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .topbar-left{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .topbar .center-dot{
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.40);
      opacity: 0.8;
    }

    .mainTop{
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .mainTop > .containsRow{
      flex: 1;
      min-height: 0;
    }

    .containsRow{
      display: grid;
      grid-template-columns: 110px 1fr 1fr;
      gap: 10px;
      padding: 10px;
      height: 100%;
      min-height: 0;
      align-items: stretch;
    }

    .idCard{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      height: 100%;
      min-height: 0;
    }
    .idCard .id{
      font-weight: 950;
      letter-spacing: 0.3px;
    }
    .idCard .badge{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      color: var(--muted);
    }
    .idCard .badge::before{
      content:"";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--orange);
      box-shadow: 0 0 0 4px rgba(245,124,0,0.12);
    }

    .miniPanel{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }
    .miniPanel .miniHeader{
      padding: 10px 10px 8px;
      font-weight: 950;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(245,124,0,0.10), transparent);
    }
    .miniPanel .miniBody{
      padding: 10px;
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.35;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      min-height: 0;
      align-items: flex-start;
    }

    .details {
      min-height: 0;
      display: grid;
      grid-template-rows: auto 1fr;
    }
    .details .panel-body{
      min-height: 0;
      overflow: auto;
    }

    .detailsGrid{
      display: grid;
      grid-template-columns: minmax(420px, 720px) 1fr;
      gap: 14px;
      align-items: start;
    }

    .card {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      padding: 12px;
    }

    .emptyHint{
      height: 100%;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.14);
      display: grid;
      place-items: center;
      padding: 20px;
      color: rgba(255,255,255,0.65);
      font-weight: 800;
      text-align: center;
    }

    .itemCard{
      padding: 14px;
      width: 100%;
      min-width: 420px;
      max-width: 720px;
      overflow: hidden;
    }
    .itemMetaGrid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 14px;
    }
    .metaRow{
      display: grid;
      gap: 4px;
      min-width: 0;
    }
    .metaRowFull{
      grid-column: 1 / -1;
    }
    .itemCard .k{
      font-size: 0.75rem;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.62);
      font-weight: 900;
    }
    .itemCard .v{
      font-weight: 900;
      color: rgba(255,255,255,0.92);
      white-space: normal;
      word-break: break-word;
    }

    .itemDivider{
      height: 1px;
      margin: 14px 0 12px;
      background: rgba(255,255,255,0.08);
    }

    .auditGrid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .auditCard{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      border-radius: 12px;
      padding: 10px 10px;
    }

    .auditLabel{
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: rgba(255,255,255,0.60);
      font-weight: 900;
      margin-bottom: 6px;
    }

    .auditValue{
      font-weight: 950;
      color: rgba(255,255,255,0.92);
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      word-break: break-word;
    }
    .auditSub{
      margin-top: 4px;
      font-weight: 800;
      color: rgba(255,255,255,0.68);
      font-size: 0.88rem;
    }

    .containsTable{
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .containsRowDraggable { cursor: grab; }
    .containsRowDraggable.dragging { opacity: 0.35; }
    .containsRowDraggable.dragOver { outline: 2px dashed rgba(245,124,0,0.7); }

    .containsTable th,
    .containsTable td{
      padding: 8px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      vertical-align: middle;
    }
    .containsTable th{
      text-align: left;
      color: rgba(255,255,255,0.75);
      font-weight: 950;
      font-size: 0.78rem;
      letter-spacing: 0.2px;
    }
    .containsCode{ font-weight: 950; color: #fff; }

    .qtyInput{
      width: 86px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: #fff;
      outline: none;
    }
    .qtyInput:focus{
      border-color: rgba(245,124,0,0.6);
      box-shadow: 0 0 0 3px rgba(245,124,0,0.12);
    }
    .rowBtn{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      padding: 8px 10px;
      border-radius: 10px;
      font-weight: 900;
      cursor: pointer;
    }
    .rowBtn:hover{
      border-color: rgba(211,47,47,0.45);
      background: rgba(211,47,47,0.12);
      transform:none;
    }

    #dropzone.drop-active{
      border-color: rgba(245,124,0,0.75) !important;
      box-shadow: 0 0 0 4px rgba(245,124,0,0.14);
    }

    .modal {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
      z-index: 50;
    }
    .modal.open { opacity: 1; pointer-events: auto; }

    .modal-card {
      width: 440px;
      max-width: 92vw;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(11,29,42,0.98), rgba(6,19,30,0.98));
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      animation: modalPop 160ms ease;
    }
    @keyframes modalPop {
      from { transform: scale(.96); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .modal-title { font-weight: 900; }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      opacity: 0.7;
      padding: 6px 10px;
      color: #fff;
    }
    .modal-close:hover { opacity: 1; }

    .modal-body {
      padding: 16px;
      display: grid;
      gap: 14px;
    }

    .form-group { display: grid; gap: 6px; }
    .form-group label {
      font-weight: 800;
      font-size: 0.85rem;
      opacity: 0.9;
    }
    .form-group input,
    .form-group select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.3);
      color: white;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: rgba(245,124,0,0.7);
      box-shadow: 0 0 0 3px rgba(245,124,0,0.15);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .modal-status{
      margin-right: auto;
      font-weight: 800;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.75);
      min-height: 1.2em;
    }

    @media (max-width: 980px) {
      .dashboard{
        grid-template-columns: 1fr;
        height: auto;
      }
      .detailsGrid{ grid-template-columns: 1fr; }
      .containsRow{ grid-template-columns: 1fr; }
      .brand .name{ max-width: 48vw; }
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <img id="companyLogo" alt="Company Logo" />
    <div class="name" id="companyName">Loading...</div>
  </div>

  <div class="actions">
    <button id="addMemberBtn" class="btn-primary" type="button">Add member</button>
    <button id="backBtn" type="button">Back</button>
    <button id="logoutBtn" class="btn-danger" type="button">Log out</button>
  </div>
</header>

<div class="dashboard">
  <!-- LEFT -->
  <div class="sidebar">
    <div class="panel findbox">
      <div class="panel-body">
        <div class="field-label">Find</div>
        <input id="findInput" type="search" placeholder="Search parts / orders / ops…" />
      </div>
    </div>

    <div class="panel tree">
      <div class="panel-header">
        <div class="treeHeader">
          <span class="dot"></span>
          <span id="treeTitle" class="treeHeaderTitle">Tree of Items</span>

          <div class="treeToggle" role="tablist" aria-label="Tree filter">
            <button id="filterAll" type="button" class="treeTab active" role="tab" aria-selected="true">All</button>
            <button id="filterRaw" type="button" class="treeTab" role="tab" aria-selected="false">Raw</button>
            <button id="filterBought" type="button" class="treeTab" role="tab" aria-selected="false">Bought</button>
            <button id="filterFinal" type="button" class="treeTab" role="tab" aria-selected="false">Final</button>
            <button id="filterOps" type="button" class="treeTab" role="tab" aria-selected="false">Ops</button>
          </div>
        </div>
      </div>

      <div class="panel-body">
        <div id="treeList"></div>
      </div>
    </div>

    <div class="panel order-ready" id="dropzone">
      <div class="panel-body">
        <div class="panel-title" style="justify-content:center;">
          <span class="dot" style="background:var(--red); box-shadow:0 0 0 4px rgba(211,47,47,0.12)"></span>
          Order Ready?
        </div>
        <div class="hint">
          (Drag &amp; drop items; opens pop-up to fill quantity, order number, etc.)
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button id="newItemBtn" class="btn-primary" type="button">New Item</button>
        <button id="newOpBtn" class="btn-primary" type="button">New Operation</button>
      </div>

      <div class="center-dot" aria-hidden="true"></div>

      <div style="display:flex; gap:10px; align-items:center; color:var(--muted); font-weight:800;">
        <span style="opacity:.9;">Company Workspace</span>
      </div>
    </div>

    <div class="panel mainTop">
      <div class="containsRow">
        <div class="idCard">
          <div class="id" id="activeItemId">—</div>
          <div class="badge">Active</div>
        </div>

        <div class="miniPanel">
          <div class="miniHeader">Contains Items:</div>
          <div class="miniBody" id="containsItems"></div>
        </div>

        <div class="miniPanel">
          <div class="miniHeader">
            Contains Operations:
            <div style="font-weight:700;font-size:.75rem;opacity:.7;margin-top:2px;">
              Drag operations into the order required (top = first operation)
            </div>
          </div>
          <div class="miniBody" id="containsOps"></div>
        </div>
      </div>
    </div>

    <div class="panel details" id="mainArea">
      <div class="panel-header">
        <div class="panel-title"><span class="dot"></span> Item Data</div>

        <div style="display:flex; gap:10px;">
          <button id="editActiveItemBtn" type="button" disabled>Edit</button>
          <button id="deleteActiveItemBtn" class="btn-danger" type="button" disabled>Delete</button>
        </div>
      </div>

      <div class="panel-body">
        <div class="detailsGrid">
          <!-- Left card (hidden once we show right panel card) -->
          <div class="card itemCard" id="leftItemCard"></div>

          <!-- Right panel that becomes a card when selected -->
          <div class="emptyHint" id="detailPanel">
            Click an item in the Tree to view it here.<br/>
            Use “New Item” to create an item.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Add Member Modal -->
<div id="addMemberModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="addMemberTitle">
    <div class="modal-header">
      <div class="modal-title" id="addMemberTitle">Add member</div>
      <button class="modal-close" id="closeAddMemberModal" type="button">✕</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="memberEmail">Email</label>
        <input id="memberEmail" type="email" placeholder="name@company.com" autocomplete="email" />
      </div>

      <div class="form-group">
        <label for="memberRole">Role</label>
        <select id="memberRole">
          <option value="member" selected>Member</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div style="color: rgba(255,255,255,0.72); font-weight: 800; font-size: 0.9rem; line-height: 1.35;">
        This calls a Firebase Cloud Function named <b>createCompanyMember</b>.
      </div>
    </div>

    <div class="modal-footer">
      <div class="modal-status" id="addMemberStatus"></div>
      <button id="cancelAddMember" type="button">Cancel</button>
      <button class="btn-primary" id="createMemberBtn" type="button">Create member</button>
    </div>
  </div>
</div>

<!-- ✅ New Item Modal -->
<div id="newItemModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="newItemTitle">
    <div class="modal-header">
      <div class="modal-title" id="newItemTitle">Create New Item</div>
      <button class="modal-close" id="closeNewItemModal" type="button">✕</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="newItemCode">Item Code</label>
        <input type="text" id="newItemCode" placeholder="e.g. P40000" autocomplete="off">
      </div>

      <div class="form-group">
        <label for="newItemType">Item Type</label>
        <select id="newItemType">
          <option value="raw_material">Raw material</option>
          <option value="bought_out">Bought out item</option>
          <option value="final_saleable" selected>Final Saleable</option>
        </select>
      </div>

      <div class="form-group">
        <label for="newItemDescription">Description</label>
        <input type="text" id="newItemDescription" placeholder="Item description" autocomplete="off">
      </div>

      <div class="form-group">
        <label for="newItemCost">Base Cost</label>
        <input type="number" id="newItemCost" placeholder="0.00" inputmode="decimal">
      </div>
    </div>

    <div class="modal-footer">
      <div class="modal-status" id="newItemStatus"></div>
      <button id="cancelNewItem" type="button">Cancel</button>
      <button class="btn-primary" id="saveNewItem" type="button">Create Item</button>
    </div>
  </div>
</div>

<!-- ✅ New Operation Modal -->
<div id="newOpModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="newOpTitle">
    <div class="modal-header">
      <div class="modal-title" id="newOpTitle">Create New Operation</div>
      <button class="modal-close" id="closeNewOpModal" type="button">✕</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="newOpCode">Operation Code</label>
        <input type="text" id="newOpCode" placeholder="e.g. BEND" autocomplete="off">
      </div>

      <div class="form-group">
        <label for="newOpPin">Station PIN</label>
        <input type="text" id="newOpPin" placeholder="e.g. 1234" inputmode="numeric" autocomplete="one-time-code">
      </div>

      <div class="form-group">
        <label for="newOpName">Display name (optional)</label>
        <input type="text" id="newOpName" placeholder="e.g. Bending" autocomplete="off">
      </div>

      <div style="color: rgba(255,255,255,0.72); font-weight: 800; font-size: 0.9rem; line-height: 1.35;">
        This creates:
        <b>companies/{companyId}/items/{OPCODE}</b> as an Operation, and
        <b>companies/{companyId}/stations/{OPCODE}</b> with your PIN.
      </div>
    </div>

    <div class="modal-footer">
      <div class="modal-status" id="newOpStatus"></div>
      <button id="cancelNewOp" type="button">Cancel</button>
      <button class="btn-primary" id="saveNewOp" type="button">Create Operation</button>
    </div>
  </div>
</div>

<!-- ✅ Delete Confirm Modal -->
<div id="deleteItemModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="deleteItemTitle">
    <div class="modal-header">
      <div class="modal-title" id="deleteItemTitle">Delete item</div>
      <button class="modal-close" id="closeDeleteItemModal" type="button">✕</button>
    </div>

    <div class="modal-body">
      <div style="font-weight:900; line-height:1.35;">
        This will permanently delete:
        <span id="deleteItemName" style="color:var(--orange);"></span>
      </div>

      <div style="color: rgba(255,255,255,0.72); font-weight:800; line-height:1.35;">
        Type <b>DELETE</b> to confirm.
      </div>

      <div class="form-group">
        <label for="deleteConfirmText">Confirmation</label>
        <input id="deleteConfirmText" type="text" placeholder="Type DELETE" autocomplete="off" />
      </div>
    </div>

    <div class="modal-footer">
      <div class="modal-status" id="deleteStatus"></div>
      <button id="cancelDeleteItem" type="button">Cancel</button>
      <button class="btn-danger" id="confirmDeleteItem" type="button" disabled>Delete</button>
    </div>
  </div>
</div>

<!-- ✅ Edit Item Modal -->
<div id="editItemModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="editItemTitle">
    <div class="modal-header">
      <div class="modal-title" id="editItemTitle">Edit Item</div>
      <button class="modal-close" id="closeEditItemModal" type="button">✕</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>Item Code</label>
        <input type="text" id="editItemCode" disabled />
      </div>

      <div class="form-group">
        <label>Description</label>
        <input type="text" id="editItemDescription" />
      </div>

      <div class="form-group">
        <label>Base Cost</label>
        <input type="number" id="editItemCost" />
      </div>
    </div>

    <div class="modal-footer">
      <div class="modal-status" id="editItemStatus"></div>
      <button id="cancelEditItem" type="button">Cancel</button>
      <button class="btn-primary" id="saveEditItem" type="button">Save Changes</button>
    </div>
  </div>
</div>

<!-- ✅ Order Ready Modal -->
<div id="orderReadyModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="orderReadyTitle">
    <div class="modal-header">
      <div class="modal-title" id="orderReadyTitle">Send to Operators</div>
      <button class="modal-close" id="closeOrderReadyModal" type="button">✕</button>
    </div>

    <div class="modal-body">
      <div style="font-weight:900; line-height:1.35;">
        Item: <span id="orderReadyItem" style="color:var(--orange);"></span>
      </div>

      <div class="form-group">
        <label for="orderReadyOrderNo">Order number</label>
        <input id="orderReadyOrderNo" type="text" placeholder="e.g. SO-100245" autocomplete="off" />
      </div>

      <div class="form-group">
        <label for="orderReadyQty">Quantity</label>
        <input id="orderReadyQty" type="number" min="1" step="1" value="1" />
      </div>

      <div class="form-group">
        <label for="orderReadyDue">Due date</label>
        <input id="orderReadyDue" type="datetime-local" />
      </div>

      <div style="color: rgba(255,255,255,0.72); font-weight: 800; font-size: 0.9rem; line-height: 1.35;">
        Confirming will send this job to the operator dashboard.
      </div>
    </div>

    <div class="modal-footer">
      <div class="modal-status" id="orderReadyStatus"></div>
      <button id="cancelOrderReady" type="button">Cancel</button>
      <button class="btn-primary" id="confirmOrderReady" type="button">Send</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc, addDoc,
    collection, onSnapshot, serverTimestamp, Timestamp,
    query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD-ArzjlwKTZVpsH4ERg7n-MEgzCt6Nzno",
    authDomain: "prodalign-ltd.firebaseapp.com",
    projectId: "prodalign-ltd"
  };

  const TYPE_LABELS = {
    raw_material: "Raw material",
    bought_out: "Bought out item",
    final_saleable: "Final Saleable",
    operation: "Operation"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const functions = getFunctions(app);

  // URL company id
  const params = new URLSearchParams(window.location.search);
  const companyId = (params.get("c") || "").trim().toLowerCase();

  // Header UI
  const companyLogoEl = document.getElementById("companyLogo");
  const companyNameEl = document.getElementById("companyName");
  const logoutBtn = document.getElementById("logoutBtn");
  const backBtn = document.getElementById("backBtn");

  // Tree + top UI
  const newItemBtn = document.getElementById("newItemBtn");
  const newOpBtn = document.getElementById("newOpBtn");
  const findInput = document.getElementById("findInput");
  const treeListEl = document.getElementById("treeList");
  const treeTitleEl = document.getElementById("treeTitle");

  // Tree filter buttons
  const filterAllBtn = document.getElementById("filterAll");
  const filterRawBtn = document.getElementById("filterRaw");
  const filterBoughtBtn = document.getElementById("filterBought");
  const filterFinalBtn = document.getElementById("filterFinal");
  const filterOpsBtn = document.getElementById("filterOps");

  // Active UI
  const activeItemIdEl = document.getElementById("activeItemId");
  const containsItemsEl = document.getElementById("containsItems");
  const containsOpsEl = document.getElementById("containsOps");

  // Detail panel
  const detailPanelEl = document.getElementById("detailPanel");
  const leftItemCardEl = document.getElementById("leftItemCard");

  const editActiveItemBtn = document.getElementById("editActiveItemBtn");
  const deleteActiveItemBtn = document.getElementById("deleteActiveItemBtn");

  // Modals: Add member
  const addMemberBtn = document.getElementById("addMemberBtn");
  const addMemberModal = document.getElementById("addMemberModal");
  const closeAddMemberModal = document.getElementById("closeAddMemberModal");
  const cancelAddMember = document.getElementById("cancelAddMember");
  const createMemberBtn = document.getElementById("createMemberBtn");
  const memberEmail = document.getElementById("memberEmail");
  const memberRole = document.getElementById("memberRole");
  const addMemberStatus = document.getElementById("addMemberStatus");

  // Modals: New item
  const newItemModal = document.getElementById("newItemModal");
  const closeNewItemModal = document.getElementById("closeNewItemModal");
  const cancelNewItem = document.getElementById("cancelNewItem");
  const saveNewItem = document.getElementById("saveNewItem");
  const newItemCode = document.getElementById("newItemCode");
  const newItemType = document.getElementById("newItemType");
  const newItemDescription = document.getElementById("newItemDescription");
  const newItemCost = document.getElementById("newItemCost");
  const newItemStatus = document.getElementById("newItemStatus");

  // Modals: New op
  const newOpModal = document.getElementById("newOpModal");
  const closeNewOpModal = document.getElementById("closeNewOpModal");
  const cancelNewOp = document.getElementById("cancelNewOp");
  const saveNewOp = document.getElementById("saveNewOp");
  const newOpCode = document.getElementById("newOpCode");
  const newOpPin = document.getElementById("newOpPin");
  const newOpName = document.getElementById("newOpName");
  const newOpStatus = document.getElementById("newOpStatus");

  // Modals: Delete
  const deleteItemModal = document.getElementById("deleteItemModal");
  const closeDeleteItemModal = document.getElementById("closeDeleteItemModal");
  const cancelDeleteItem = document.getElementById("cancelDeleteItem");
  const confirmDeleteItem = document.getElementById("confirmDeleteItem");
  const deleteConfirmText = document.getElementById("deleteConfirmText");
  const deleteItemName = document.getElementById("deleteItemName");
  const deleteStatus = document.getElementById("deleteStatus");
  let pendingDeleteCode = null;

  // Modals: Edit
  const editItemModal = document.getElementById("editItemModal");
  const closeEditItemModal = document.getElementById("closeEditItemModal");
  const cancelEditItem = document.getElementById("cancelEditItem");
  const saveEditItem = document.getElementById("saveEditItem");
  const editItemCode = document.getElementById("editItemCode");
  const editItemDescription = document.getElementById("editItemDescription");
  const editItemCost = document.getElementById("editItemCost");
  const editItemStatus = document.getElementById("editItemStatus");
  let pendingEditCode = null;

  // Order ready modal
  const dropzone = document.getElementById("dropzone");
  const orderReadyModal = document.getElementById("orderReadyModal");
  const closeOrderReadyModal = document.getElementById("closeOrderReadyModal");
  const cancelOrderReady = document.getElementById("cancelOrderReady");
  const confirmOrderReady = document.getElementById("confirmOrderReady");
  const orderReadyItem = document.getElementById("orderReadyItem");
  const orderReadyOrderNo = document.getElementById("orderReadyOrderNo");
  const orderReadyQty = document.getElementById("orderReadyQty");
  const orderReadyDue = document.getElementById("orderReadyDue");
  const orderReadyStatus = document.getElementById("orderReadyStatus");
  let pendingOrderReady = null;

  // ---------- State ----------
  let treeFilter = "all"; // all | raw_material | bought_out | final_saleable | operation

  let allOps = [];
  let allRaw = [];
  let allBought = [];
  let allFinal = [];
  let allNonOps = [];
  let allItems = [];

  let activeItemCode = null;
  let activeItemData = null;

  const itemsByCode = new Map(); // code -> item

  if (!companyId) {
    companyNameEl.textContent = "Missing company id (?c=...)";
    throw new Error("Missing ?c=");
  }

  // ---------- Helpers ----------
  function getUserIdentifier(){
    const u = auth.currentUser;
    if (!u) return null;
    return (
      u.email ||
      u.providerData?.find(p => p?.email)?.email ||
      u.displayName ||
      u.uid ||
      null
    );
  }

  function formatDateOnly(ts){
    try{
      const d =
        ts?.toDate ? ts.toDate() :
        ts instanceof Date ? ts :
        typeof ts === "number" ? new Date(ts) :
        null;

      if (!d || Number.isNaN(d.getTime())) return "—";
      return new Intl.DateTimeFormat("en-GB", { day:"2-digit", month:"short", year:"numeric" }).format(d);
    } catch {
      return "—";
    }
  }

  function normalizeContains(contains){
    if (!Array.isArray(contains)) return [];
    return contains
      .map(x => {
        if (typeof x === "string") return { code: x.trim().toUpperCase(), qty: 1 };
        if (x && typeof x === "object") {
          const code = String(x.code || "").trim().toUpperCase();
          const qtyN = Number(x.qty);
          const qty = Number.isFinite(qtyN) && qtyN > 0 ? Math.floor(qtyN) : 1;
          return code ? { code, qty } : null;
        }
        return null;
      })
      .filter(Boolean);
  }

  function normalizeOperations(ops){
    if (!Array.isArray(ops)) return [];
    return ops
      .map(x => {
        if (typeof x === "string") return { code: x.trim().toUpperCase(), iph: 0 };
        if (x && typeof x === "object") {
          const code = String(x.code || "").trim().toUpperCase();
          const iphN = Number(x.iph);
          const iph = Number.isFinite(iphN) && iphN >= 0 ? iphN : 0;
          return code ? { code, iph } : null;
        }
        return null;
      })
      .filter(Boolean);
  }

  function renderContainsTable(container, containsArr){
    const rows = normalizeContains(containsArr);

    if (rows.length === 0) {
      container.style.color = "rgba(255,255,255,0.65)";
      container.innerHTML = "No contained items";
      return;
    }

    container.style.color = "";
    container.innerHTML = `
      <table class="containsTable">
        <thead>
          <tr>
            <th style="width:55%;">Item</th>
            <th style="width:25%;">Qty</th>
            <th style="width:20%;"></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr data-code="${r.code}">
              <td class="containsCode">${r.code}</td>
              <td><input class="qtyInput" type="number" min="1" step="1" value="${r.qty}" /></td>
              <td style="text-align:right;"><button class="rowBtn" type="button" data-remove="1">Remove</button></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function renderOperationsTable(container, opsArr){
    const rows = normalizeOperations(opsArr);

    if (rows.length === 0) {
      container.style.color = "rgba(255,255,255,0.65)";
      container.innerHTML = "No operations";
      return;
    }

    container.style.color = "";
    container.innerHTML = `
      <table class="containsTable">
        <thead>
          <tr>
            <th style="width:10%;">#</th>
            <th style="width:45%;">Operation</th>
            <th style="width:25%;">Items/hr</th>
            <th style="width:20%;"></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r,i) => `
            <tr data-code="${r.code}" draggable="true" class="containsRowDraggable">
              <td style="font-weight:900;">${i+1}</td>
              <td class="containsCode">${r.code}</td>
              <td><input class="qtyInput opIphInput" type="number" min="0" step="0.1" value="${r.iph}" /></td>
              <td style="text-align:right;"><button class="rowBtn" type="button" data-op-remove="1">Remove</button></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function renderDetailPanel(item){
    if (leftItemCardEl) leftItemCardEl.style.display = "none";

    if (!item || !activeItemCode) {
      detailPanelEl.className = "emptyHint";
      detailPanelEl.innerHTML = `
        Click an item in the Tree to view it here.<br/>
        Use “New Item” to create an item.
      `;
      return;
    }

    detailPanelEl.className = "card itemCard";
    detailPanelEl.innerHTML = `
      <div class="itemMetaGrid">
        <div class="metaRow">
          <div class="k">Item</div>
          <div class="v">${activeItemCode}</div>
        </div>

        <div class="metaRow">
          <div class="k">Type</div>
          <div class="v">${TYPE_LABELS[item?.type] || "—"}</div>
        </div>

        <div class="metaRow">
          <div class="k">Item Cost</div>
          <div class="v">${item?.baseCost ?? "—"}</div>
        </div>

        <div class="metaRow">
          <div class="k">Operation Time</div>
          <div class="v">${item?.operationTime ?? "—"}</div>
        </div>

        <div class="metaRow metaRowFull">
          <div class="k">Description</div>
          <div class="v">${item?.description ?? "—"}</div>
        </div>
      </div>

      <div class="itemDivider"></div>

      <div class="auditGrid">
        <div class="auditCard">
          <div class="auditLabel">Created</div>
          <div class="auditValue">${item?.createdBy ?? "—"}</div>
          <div class="auditSub">${formatDateOnly(item?.createdAt)}</div>
        </div>

        <div class="auditCard">
          <div class="auditLabel">Last edited</div>
          <div class="auditValue">${item?.updatedBy ?? "—"}</div>
          <div class="auditSub">${formatDateOnly(item?.updatedAt)}</div>
        </div>
      </div>
    `;
  }

  function setActiveItem(item){
    const code = (item?.code || "—").toUpperCase();
    activeItemCode = (code && code !== "—") ? code : null;
    activeItemData = item || null;

    activeItemIdEl.textContent = code || "—";

    renderContainsTable(containsItemsEl, item?.contains);
    renderOperationsTable(containsOpsEl, item?.operations);
    renderDetailPanel(item);

    const has = !!activeItemCode;
    editActiveItemBtn.disabled = !has;
    deleteActiveItemBtn.disabled = !has;
  }

  // ---------- Save helpers (debounced) ----------
  let qtySaveTimer = null;
  let iphSaveTimer = null;

  async function saveContainsToActive(newContains){
    if (!activeItemCode) return;
    await setDoc(doc(db, "companies", companyId, "items", activeItemCode), {
      contains: newContains,
      updatedBy: getUserIdentifier(),
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  function scheduleQtySave(newContains){
    clearTimeout(qtySaveTimer);
    qtySaveTimer = setTimeout(() => {
      saveContainsToActive(newContains).catch(console.error);
    }, 250);
  }

  async function saveOperationsToActive(newOperations){
    if (!activeItemCode) return;
    await setDoc(doc(db, "companies", companyId, "items", activeItemCode), {
      operations: newOperations,
      updatedBy: getUserIdentifier(),
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  function scheduleIphSave(newOperations){
    clearTimeout(iphSaveTimer);
    iphSaveTimer = setTimeout(() => {
      saveOperationsToActive(newOperations).catch(console.error);
    }, 250);
  }

  // ---------- Editable contains items ----------
  containsItemsEl.addEventListener("input", (e) => {
    const input = e.target;
    if (!(input instanceof HTMLInputElement)) return;
    if (!input.classList.contains("qtyInput")) return;
    if (input.classList.contains("opIphInput")) return;

    const tr = input.closest("tr");
    const code = tr?.dataset?.code;
    if (!code || !activeItemData) return;

    const qty = Math.max(1, Math.floor(Number(input.value || 1)));
    input.value = String(qty);

    const normalized = normalizeContains(activeItemData.contains);
    const next = normalized.map(r => r.code === code ? ({ ...r, qty }) : r);

    activeItemData = { ...activeItemData, contains: next, code: activeItemCode };
    scheduleQtySave(next);
  });

  containsItemsEl.addEventListener("click", (e) => {
    const btn = e.target;
    if (!(btn instanceof HTMLElement)) return;
    if (!btn.dataset.remove) return;

    const tr = btn.closest("tr");
    const code = tr?.dataset?.code;
    if (!code || !activeItemData) return;

    const normalized = normalizeContains(activeItemData.contains);
    const next = normalized.filter(r => r.code !== code);

    activeItemData = { ...activeItemData, contains: next, code: activeItemCode };
    renderContainsTable(containsItemsEl, next);
    saveContainsToActive(next).catch(console.error);
  });

  // ---------- Editable ops table (iph + remove + reorder) ----------
  containsOpsEl.addEventListener("input", (e) => {
    const input = e.target;
    if (!(input instanceof HTMLInputElement)) return;
    if (!input.classList.contains("opIphInput")) return;

    const tr = input.closest("tr");
    const code = tr?.dataset?.code;
    if (!code || !activeItemData) return;

    const raw = Number(input.value);
    const iph = Number.isFinite(raw) && raw >= 0 ? raw : 0;
    input.value = String(iph);

    const normalized = normalizeOperations(activeItemData.operations);
    const next = normalized.map(r => r.code === code ? ({ ...r, iph }) : r);

    activeItemData = { ...activeItemData, operations: next, code: activeItemCode };
    scheduleIphSave(next);
  });

  let opDragSourceCode = null;

  containsOpsEl.addEventListener("dragstart", (e) => {
    const row = e.target?.closest?.("tr");
    if (!row) return;
    opDragSourceCode = row.dataset.code || null;
    row.classList.add("dragging");
  });

  containsOpsEl.addEventListener("dragend", (e) => {
    const row = e.target?.closest?.("tr");
    if (row) row.classList.remove("dragging");
    opDragSourceCode = null;
  });

  containsOpsEl.addEventListener("dragover", (e) => {
    e.preventDefault();
    const row = e.target?.closest?.("tr");
    if (!row || !opDragSourceCode) return;
    row.classList.add("dragOver");
  });

  containsOpsEl.addEventListener("dragleave", (e) => {
    const row = e.target?.closest?.("tr");
    if (row) row.classList.remove("dragOver");
  });

  containsOpsEl.addEventListener("drop", async (e) => {
    e.preventDefault();

    const targetRow = e.target?.closest?.("tr");
    if (!targetRow || !opDragSourceCode || !activeItemData) return;

    targetRow.classList.remove("dragOver");

    const targetCode = targetRow.dataset.code;
    if (!targetCode || targetCode === opDragSourceCode) return;

    const list = normalizeOperations(activeItemData.operations);

    const fromIndex = list.findIndex(i => i.code === opDragSourceCode);
    const toIndex = list.findIndex(i => i.code === targetCode);
    if (fromIndex < 0 || toIndex < 0) return;

    const moved = list.splice(fromIndex, 1)[0];
    list.splice(toIndex, 0, moved);

    activeItemData = { ...activeItemData, operations: list, code: activeItemCode };
    renderOperationsTable(containsOpsEl, list);
    await saveOperationsToActive(list);
  });

  containsOpsEl.addEventListener("click", (e) => {
    const btn = e.target;
    if (!(btn instanceof HTMLElement)) return;
    if (!btn.dataset.opRemove) return;

    const tr = btn.closest("tr");
    const code = tr?.dataset?.code;
    if (!code || !activeItemData) return;

    const normalized = normalizeOperations(activeItemData.operations);
    const next = normalized.filter(r => r.code !== code);

    activeItemData = { ...activeItemData, operations: next, code: activeItemCode };
    renderOperationsTable(containsOpsEl, next);
    saveOperationsToActive(next).catch(console.error);
  });

  // ---------- Drag/drop UI helpers ----------
  function setDropActive(el, isActive){
    const panel = el.closest(".miniPanel");
    if (!panel) return;
    panel.style.borderColor = isActive ? "rgba(245,124,0,0.65)" : "rgba(255,255,255,0.10)";
    panel.style.boxShadow = isActive ? "0 0 0 4px rgba(245,124,0,0.12)" : "none";
  }

  function readDragPayload(dt){
    try {
      const raw = dt.getData("application/json");
      if (raw) return JSON.parse(raw);
    } catch {}
    const code = (dt.getData("text/plain") || "").trim().toUpperCase();
    return code ? { code, type: "" } : null;
  }

  async function resolveItemType(code, fallbackType){
    const clean = String(code || "").trim().toUpperCase();
    const typeLower = String(fallbackType || "").toLowerCase();
    if (typeLower) return typeLower;

    const cached = itemsByCode.get(clean);
    if (cached?.type) return String(cached.type).toLowerCase();

    try {
      const snap = await getDoc(doc(db, "companies", companyId, "items", clean));
      if (!snap.exists()) return "";
      return String(snap.data()?.type || "").toLowerCase();
    } catch {
      return "";
    }
  }

  // ---------- Drop into Contains Items ----------
  async function addContainedItemToActiveItem(containedCode) {
    if (!activeItemCode) {
      alert("Select an item first (the one that will contain the part).");
      return;
    }

    const child = String(containedCode || "").trim().toUpperCase();
    if (!child) return;

    if (child === activeItemCode) {
      alert("An item cannot contain itself.");
      return;
    }

    const parentRef = doc(db, "companies", companyId, "items", activeItemCode);
    const snap = await getDoc(parentRef);
    if (!snap.exists()) throw new Error(`Active item '${activeItemCode}' no longer exists.`);

    const data = snap.data() || {};
    const current = normalizeContains(data.contains);
    if (current.some(r => r.code === child)) return;

    const next = [...current, { code: child, qty: 1 }];

    await setDoc(parentRef, {
      contains: next,
      updatedBy: getUserIdentifier(),
      updatedAt: serverTimestamp()
    }, { merge: true });

    activeItemData = { ...(activeItemData || {}), code: activeItemCode, contains: next };
    renderContainsTable(containsItemsEl, next);
  }

  containsItemsEl.addEventListener("dragenter", (e) => { e.preventDefault(); setDropActive(containsItemsEl, true); });
  containsItemsEl.addEventListener("dragover", (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "copy"; });
  containsItemsEl.addEventListener("dragleave", (e) => {
    if (e.relatedTarget && containsItemsEl.contains(e.relatedTarget)) return;
    setDropActive(containsItemsEl, false);
  });
  containsItemsEl.addEventListener("drop", async (e) => {
    e.preventDefault();
    setDropActive(containsItemsEl, false);

    const payload = readDragPayload(e.dataTransfer);
    if (!payload?.code) return;

    const type = await resolveItemType(payload.code, payload.type);
    if (type === "operation") {
      alert("Operations can only be dropped into Contains Operations.");
      return;
    }

    try {
      await addContainedItemToActiveItem(payload.code);
    } catch (err) {
      console.error(err);
      alert(err?.message || "Failed to add contained item.");
    }
  });

  // ---------- Drop into Contains Operations ----------
  async function addOperationToActiveItem(opCode){
    if (!activeItemCode) {
      alert("Select an item first (the one that will contain the operation).");
      return;
    }

    const child = String(opCode || "").trim().toUpperCase();
    if (!child) return;

    if (child === activeItemCode) {
      alert("An item cannot contain itself.");
      return;
    }

    const parentRef = doc(db, "companies", companyId, "items", activeItemCode);
    const snap = await getDoc(parentRef);
    if (!snap.exists()) throw new Error(`Active item '${activeItemCode}' no longer exists.`);

    const data = snap.data() || {};
    const current = normalizeOperations(data.operations);
    if (current.some(r => r.code === child)) return;

    const next = [...current, { code: child, iph: 0 }];

    await setDoc(parentRef, {
      operations: next,
      updatedBy: getUserIdentifier(),
      updatedAt: serverTimestamp()
    }, { merge: true });

    activeItemData = { ...(activeItemData || {}), code: activeItemCode, operations: next };
    renderOperationsTable(containsOpsEl, next);
  }

  containsOpsEl.addEventListener("dragenter", (e) => { e.preventDefault(); setDropActive(containsOpsEl, true); });
  containsOpsEl.addEventListener("dragover", (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "copy"; });
  containsOpsEl.addEventListener("dragleave", (e) => {
    if (e.relatedTarget && containsOpsEl.contains(e.relatedTarget)) return;
    setDropActive(containsOpsEl, false);
  });
  containsOpsEl.addEventListener("drop", async (e) => {
    e.preventDefault();
    setDropActive(containsOpsEl, false);

    const payload = readDragPayload(e.dataTransfer);
    if (!payload?.code) return;

    const type = await resolveItemType(payload.code, payload.type);
    if (type !== "operation") {
      alert("Only items with Item Type = Operation can be dropped into Contains Operations.");
      return;
    }

    try {
      await addOperationToActiveItem(payload.code);
    } catch (err) {
      console.error(err);
      alert(err?.message || "Failed to add operation.");
    }
  });

  // ---------- Tree ----------
  function renderTree(items, queryText = "") {
    const q = String(queryText || "").trim().toLowerCase();
    treeListEl.innerHTML = "";

    const filtered = !q ? items : items.filter(it => {
      const code = String(it.code || "").toLowerCase();
      const desc = String(it.description || "").toLowerCase();
      return code.includes(q) || desc.includes(q);
    });

    if (filtered.length === 0) {
      treeListEl.style.color = "rgba(255,255,255,0.65)";
      treeListEl.textContent = q
        ? `No results for "${queryText}"`
        : "No items yet. Click “New Item” to create one.";
      return;
    }

    treeListEl.style.color = "";

    filtered.forEach((item) => {
      const code = (item.code || "").toUpperCase();

      const row = document.createElement("div");
      row.className = "tree-item";
      row.draggable = true;

      row.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("application/json", JSON.stringify({ code, type: item.type || "" }));
        e.dataTransfer.setData("text/plain", code);
        e.dataTransfer.effectAllowed = "copy";
      });

      const left = document.createElement("div");
      left.className = "left";
      left.innerHTML = `
        <strong>${code}</strong>
        <div class="muted">${item.description || "—"}</div>
      `;
      left.addEventListener("click", () => setActiveItem(item));

      row.appendChild(left);
      treeListEl.appendChild(row);
    });
  }

  function renderCurrentTree() {
    let list = allNonOps; // ✅ All = non-ops by default

    if (treeFilter === "operation") list = allOps;
    else if (treeFilter === "raw_material") list = allRaw;
    else if (treeFilter === "bought_out") list = allBought;
    else if (treeFilter === "final_saleable") list = allFinal;
    else if (treeFilter === "all") list = allNonOps;

    if (treeTitleEl) {
      const title =
        treeFilter === "operation" ? "Tree of Operations" :
        treeFilter === "raw_material" ? "Tree of Raw Materials" :
        treeFilter === "bought_out" ? "Tree of Bought Out Items" :
        treeFilter === "final_saleable" ? "Tree of Final Saleable Items" :
        "Tree of All Items";

      treeTitleEl.textContent = title;
    }

    renderTree(list, findInput.value);
  }

  function setTreeFilter(next) {
    treeFilter = next;

    const map = [
      [filterAllBtn, "all"],
      [filterRawBtn, "raw_material"],
      [filterBoughtBtn, "bought_out"],
      [filterFinalBtn, "final_saleable"],
      [filterOpsBtn, "operation"],
    ];

    map.forEach(([btn, key]) => {
      if (!btn) return;
      const active = treeFilter === key;
      btn.classList.toggle("active", active);
      btn.setAttribute("aria-selected", active ? "true" : "false");
    });

    renderCurrentTree();
  }

  filterAllBtn?.addEventListener("click", () => setTreeFilter("all"));
  filterRawBtn?.addEventListener("click", () => setTreeFilter("raw_material"));
  filterBoughtBtn?.addEventListener("click", () => setTreeFilter("bought_out"));
  filterFinalBtn?.addEventListener("click", () => setTreeFilter("final_saleable"));
  filterOpsBtn?.addEventListener("click", () => setTreeFilter("operation"));

  findInput.addEventListener("input", () => renderCurrentTree());

  function watchItems(companyId){
    const itemsRef = collection(db, "companies", companyId, "items");

    onSnapshot(itemsRef, (snap) => {
      let firstNonOp = null;

      itemsByCode.clear();
      allItems = [];
      allOps = [];
      allRaw = [];
      allBought = [];
      allFinal = [];
      allNonOps = [];

      snap.forEach((d) => {
        const item = d.data() || {};
        const code = (item.code || d.id || "").toUpperCase();
        const normalized = { ...item, code };

        itemsByCode.set(code, normalized);
        allItems.push(normalized);

        const type = String(normalized.type || "").toLowerCase();
        if (type === "operation") {
          allOps.push(normalized);
        } else {
          allNonOps.push(normalized);
          if (!firstNonOp) firstNonOp = normalized;

          if (type === "raw_material") allRaw.push(normalized);
          else if (type === "bought_out") allBought.push(normalized);
          else if (type === "final_saleable") allFinal.push(normalized);
        }
      });

      // Keep active selection fresh
      if (activeItemCode && itemsByCode.has(activeItemCode)) {
        setActiveItem(itemsByCode.get(activeItemCode));
      } else if (!activeItemCode && firstNonOp) {
        setActiveItem(firstNonOp);
      } else if (firstNonOp) {
        setActiveItem(firstNonOp);
      } else {
        setActiveItem(null);
      }

      renderCurrentTree();
    }, (err) => {
      console.error("Tree listener error:", err);
      treeListEl.innerHTML = `<div style="color:#ffb4b4;font-weight:900;">
        Error loading items: ${err.message}
      </div>`;
    });
  }

  // ---------- Branding + auth ----------
  async function loadCompanyBranding(companyId) {
    const snap = await getDoc(doc(db, "companies", companyId));
    if (!snap.exists()) {
      companyNameEl.textContent = `Company '${companyId}' not found`;
      return;
    }

    const company = snap.data() || {};
    const name = company.displayname || "Company";
    const logoUrl = company.Logourl || "";

    companyNameEl.textContent = name;
    if (logoUrl) {
      companyLogoEl.src = logoUrl;       // ✅ correct variable
      companyLogoEl.style.display = "block";
    }

    document.title = `${name} | Settings`;
  }

  async function enforceUserCompany(user, companyId) {
    const userSnap = await getDoc(doc(db, "users", user.uid));
    if (!userSnap.exists()) throw new Error("User profile missing (users/{uid}).");

    const data = userSnap.data() || {};
    const userCompany = String(data.companycode ?? data.companyCode ?? "").trim().toLowerCase();

    if (!userCompany) throw new Error("User profile missing companycode.");
    if (userCompany !== companyId) throw new Error("Access denied for this company.");
    return true;
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
      return;
    }

    try {
      await enforceUserCompany(user, companyId);
      await loadCompanyBranding(companyId);
      watchItems(companyId);
    } catch (err) {
      console.error(err);
      try { await signOut(auth); } catch {}
      window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
    }
  });

  // ---------- Navigation ----------
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
  });

  backBtn.addEventListener("click", () => {
    window.location.assign(`./index.html?c=${encodeURIComponent(companyId)}`);
  });

  // ---------- Edit modal ----------
  function openEditItemModal(item){
    if (!item?.code) return;
    pendingEditCode = item.code;

    editItemCode.value = item.code;
    editItemDescription.value = item.description || "";
    editItemCost.value = (item.baseCost ?? "");

    editItemStatus.textContent = "";
    editItemModal.classList.add("open");
    editItemModal.setAttribute("aria-hidden", "false");
    setTimeout(() => editItemDescription.focus(), 0);
  }

  function closeEditItemModalFn(){
    editItemModal.classList.remove("open");
    editItemModal.setAttribute("aria-hidden", "true");
    pendingEditCode = null;
  }

  closeEditItemModal.addEventListener("click", closeEditItemModalFn);
  cancelEditItem.addEventListener("click", closeEditItemModalFn);
  editItemModal.addEventListener("click", (e)=>{ if(e.target === editItemModal) closeEditItemModalFn(); });

  saveEditItem.addEventListener("click", async ()=>{
    if(!pendingEditCode) return;

    const description = editItemDescription.value.trim();
    const baseCost = Number(editItemCost.value || 0);

    saveEditItem.disabled = true;
    editItemStatus.textContent = "Saving…";

    try{
      await setDoc(
        doc(db, "companies", companyId, "items", pendingEditCode),
        {
          description,
          baseCost: Number.isFinite(baseCost) ? baseCost : 0,
          updatedBy: getUserIdentifier(),
          updatedAt: serverTimestamp()
        },
        { merge: true }
      );

      editItemStatus.textContent = "Saved!";
      setTimeout(closeEditItemModalFn, 300);
    } catch(err){
      console.error(err);
      editItemStatus.textContent = err?.message || "Save failed.";
    } finally{
      saveEditItem.disabled = false;
    }
  });

  // ---------- New Item modal ----------
  function openNewItemModal() {
    newItemStatus.textContent = "";
    newItemCode.value = "";
    newItemType.value = "final_saleable";
    newItemDescription.value = "";
    newItemCost.value = "";
    newItemModal.classList.add("open");
    newItemModal.setAttribute("aria-hidden", "false");
    setTimeout(() => newItemCode.focus(), 0);
  }
  function closeNewItemModalFn() {
    newItemModal.classList.remove("open");
    newItemModal.setAttribute("aria-hidden", "true");
  }

  newItemBtn.addEventListener("click", openNewItemModal);
  closeNewItemModal.addEventListener("click", closeNewItemModalFn);
  cancelNewItem.addEventListener("click", closeNewItemModalFn);
  newItemModal.addEventListener("click", (e) => { if (e.target === newItemModal) closeNewItemModalFn(); });

  saveNewItem.addEventListener("click", async () => {
    let type = String(newItemType.value || "final_saleable");
    if (type.toLowerCase() === "operation") type = "final_saleable";

    const code = String(newItemCode.value || "").trim().toUpperCase();
    const description = String(newItemDescription.value || "").trim();
    const baseCost = Number(newItemCost.value || 0);

    if (!code) {
      newItemStatus.textContent = "Item code is required.";
      return;
    }

    saveNewItem.disabled = true;
    newItemStatus.textContent = "Saving…";

    try {
      const itemRef = doc(db, "companies", companyId, "items", code);
      const existing = await getDoc(itemRef);
      if (existing.exists()) {
        newItemStatus.textContent = `${code} already exists.`;
        return;
      }

      await setDoc(itemRef, {
        code,
        type,
        description,
        baseCost: Number.isFinite(baseCost) ? baseCost : 0,
        contains: [],
        operations: [],
        createdBy: getUserIdentifier(),
        updatedBy: getUserIdentifier(),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      newItemStatus.textContent = "Saved!";
      setTimeout(closeNewItemModalFn, 350);
    } catch (err) {
      console.error(err);
      newItemStatus.textContent = err?.message || "Failed to save item.";
    } finally {
      saveNewItem.disabled = false;
    }
  });

  // ---------- New Operation modal ----------
  function openNewOpModal() {
    newOpStatus.textContent = "";
    newOpCode.value = "";
    newOpPin.value = "";
    newOpName.value = "";
    newOpModal.classList.add("open");
    newOpModal.setAttribute("aria-hidden", "false");
    setTimeout(() => newOpCode.focus(), 0);
  }

  function closeNewOpModalFn() {
    newOpModal.classList.remove("open");
    newOpModal.setAttribute("aria-hidden", "true");
  }

  newOpBtn?.addEventListener("click", openNewOpModal);
  closeNewOpModal?.addEventListener("click", closeNewOpModalFn);
  cancelNewOp?.addEventListener("click", closeNewOpModalFn);
  newOpModal?.addEventListener("click", (e) => { if (e.target === newOpModal) closeNewOpModalFn(); });

  newOpPin?.addEventListener("input", () => {
    newOpPin.value = newOpPin.value.replace(/[^\d]/g, "").slice(0, 12);
  });

  async function isPinTaken(companyId, pin) {
    const qPins = query(
      collection(db, "companies", companyId, "stations"),
      where("pin", "==", pin),
      where("active", "==", true)
    );
    const snap = await getDocs(qPins);
    return !snap.empty;
  }

  saveNewOp?.addEventListener("click", async () => {
    const code = String(newOpCode.value || "").trim().toUpperCase();
    const pin = String(newOpPin.value || "").trim();
    const displayName = String(newOpName.value || "").trim();

    if (!code) { newOpStatus.textContent = "Operation code is required."; return; }
    if (!pin) { newOpStatus.textContent = "Station PIN is required."; return; }

    saveNewOp.disabled = true;
    newOpStatus.textContent = "Checking…";

    try {
      const taken = await isPinTaken(companyId, pin);
      if (taken) {
        newOpStatus.textContent = "That PIN is already in use for this company.";
        return;
      }

      const stationRef = doc(db, "companies", companyId, "stations", code);
      const existingStation = await getDoc(stationRef);
      if (existingStation.exists()) throw new Error(`Station '${code}' already exists.`);

      const itemRef = doc(db, "companies", companyId, "items", code);
      const existingItem = await getDoc(itemRef);
      if (existingItem.exists()) {
        const t = String(existingItem.data()?.type || "").toLowerCase();
        if (t && t !== "operation") throw new Error(`${code} already exists and is not an Operation.`);
        throw new Error(`${code} operation already exists.`);
      }

      newOpStatus.textContent = "Saving…";

      await setDoc(itemRef, {
        code,
        type: "operation",
        description: displayName || code,
        baseCost: 0,
        contains: [],
        operations: [],
        createdBy: getUserIdentifier(),
        updatedBy: getUserIdentifier(),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      await setDoc(stationRef, {
        companyId,
        pin,
        active: true,
        opCode: code,
        displayName: displayName || code,
        createdBy: getUserIdentifier(),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      newOpStatus.textContent = "Created!";
      setTreeFilter("operation");
      setTimeout(closeNewOpModalFn, 350);

    } catch (err) {
      console.error(err);
      newOpStatus.textContent = err?.message || "Failed to create operation.";
    } finally {
      saveNewOp.disabled = false;
    }
  });

  // ---------- Delete modal (also deletes station if operation) ----------
  function openDeleteModal(code){
    pendingDeleteCode = code;
    deleteItemName.textContent = code;
    deleteConfirmText.value = "";
    deleteStatus.textContent = "";
    confirmDeleteItem.disabled = true;

    deleteItemModal.classList.add("open");
    deleteItemModal.setAttribute("aria-hidden", "false");
    setTimeout(() => deleteConfirmText.focus(), 0);
  }

  function closeDeleteModal(){
    deleteItemModal.classList.remove("open");
    deleteItemModal.setAttribute("aria-hidden", "true");
    pendingDeleteCode = null;
  }

  closeDeleteItemModal.addEventListener("click", closeDeleteModal);
  cancelDeleteItem.addEventListener("click", closeDeleteModal);
  deleteItemModal.addEventListener("click", (e) => { if (e.target === deleteItemModal) closeDeleteModal(); });

  deleteConfirmText.addEventListener("input", () => {
    confirmDeleteItem.disabled = deleteConfirmText.value.trim().toUpperCase() !== "DELETE";
  });

  confirmDeleteItem.addEventListener("click", async () => {
    if (!pendingDeleteCode) return;
    if (deleteConfirmText.value.trim().toUpperCase() !== "DELETE") return;

    confirmDeleteItem.disabled = true;
    deleteStatus.textContent = "Deleting…";

    try {
      const itemRef = doc(db, "companies", companyId, "items", pendingDeleteCode);
      const snap = await getDoc(itemRef);

      const type = String(snap.data()?.type || "").toLowerCase();

      // ✅ if operation, also remove its station doc
      if (type === "operation") {
        await deleteDoc(doc(db, "companies", companyId, "stations", pendingDeleteCode));
      }

      await deleteDoc(itemRef);

      deleteStatus.textContent = "Deleted.";
      setTimeout(closeDeleteModal, 250);
    } catch (err) {
      console.error(err);
      deleteStatus.textContent = err?.message || "Delete failed.";
      confirmDeleteItem.disabled = false;
    }
  });

  // ---------- Add member modal ----------
  function openAddMemberModal() {
    addMemberStatus.textContent = "";
    memberEmail.value = "";
    memberRole.value = "member";
    addMemberModal.classList.add("open");
    addMemberModal.setAttribute("aria-hidden", "false");
    setTimeout(() => memberEmail.focus(), 0);
  }
  function closeAddMemberModalFn() {
    addMemberModal.classList.remove("open");
    addMemberModal.setAttribute("aria-hidden", "true");
  }

  addMemberBtn.addEventListener("click", openAddMemberModal);
  closeAddMemberModal.addEventListener("click", closeAddMemberModalFn);
  cancelAddMember.addEventListener("click", closeAddMemberModalFn);
  addMemberModal.addEventListener("click", (e) => { if (e.target === addMemberModal) closeAddMemberModalFn(); });

  async function callCreateCompanyMember(email, role) {
    const fn = httpsCallable(functions, "createCompanyMember");
    const res = await fn({ companyId, email, role });
    return res.data;
  }

  createMemberBtn.addEventListener("click", async () => {
    const email = memberEmail.value.trim().toLowerCase();
    const role = memberRole.value === "admin" ? "admin" : "member";

    if (!email || !email.includes("@")) {
      addMemberStatus.textContent = "Enter a valid email.";
      return;
    }

    createMemberBtn.disabled = true;
    addMemberStatus.textContent = "Creating member…";

    try {
      const data = await callCreateCompanyMember(email, role);
      addMemberStatus.textContent = `Member added: ${data.email || email}`;
      setTimeout(closeAddMemberModalFn, 800);
    } catch (err) {
      console.error(err);
      addMemberStatus.textContent = err?.message || "Could not create member.";
    } finally {
      createMemberBtn.disabled = false;
    }
  });

  // ---------- Active item action buttons ----------
  editActiveItemBtn?.addEventListener("click", () => {
    if (!activeItemData) return;
    openEditItemModal(activeItemData);
  });

  deleteActiveItemBtn?.addEventListener("click", () => {
    if (!activeItemCode) return;
    openDeleteModal(activeItemCode);
  });

  // ---------- Order Ready (Dropzone -> Modal -> Firestore job) ----------
  function openOrderReadyModal(payload){
    pendingOrderReady = payload;

    orderReadyItem.textContent = payload?.code || "—";
    orderReadyOrderNo.value = "";
    orderReadyQty.value = "1";
    orderReadyDue.value = "";
    orderReadyStatus.textContent = "";

    orderReadyModal.classList.add("open");
    orderReadyModal.setAttribute("aria-hidden", "false");
    setTimeout(() => orderReadyOrderNo.focus(), 0);
  }

  function closeOrderReadyModalFn(){
    orderReadyModal.classList.remove("open");
    orderReadyModal.setAttribute("aria-hidden", "true");
    pendingOrderReady = null;
  }

  closeOrderReadyModal?.addEventListener("click", closeOrderReadyModalFn);
  cancelOrderReady?.addEventListener("click", closeOrderReadyModalFn);
  orderReadyModal?.addEventListener("click", (e) => { if (e.target === orderReadyModal) closeOrderReadyModalFn(); });

  async function getItemOpsInOrder(itemCode){
    const snap = await getDoc(doc(db, "companies", companyId, "items", itemCode));
    if (!snap.exists()) throw new Error(`Item ${itemCode} not found.`);
    const data = snap.data() || {};
    const ops = normalizeOperations(data.operations);
    if (!ops.length) throw new Error(`Item ${itemCode} has no operations. Add operations first.`);
    return ops;
  }

  async function sendOrderToOperators({ code, type }){
    const itemCode = String(code || "").trim().toUpperCase();
    if (!itemCode) throw new Error("Missing item code.");

    const resolvedType = await resolveItemType(itemCode, type);
    if (resolvedType === "operation") throw new Error("Drop a normal item (not an Operation).");

    const orderNo = String(orderReadyOrderNo.value || "").trim();
    const qty = Math.max(1, Math.floor(Number(orderReadyQty.value || 1)));
    if (!orderNo) throw new Error("Order number is required.");

    const dueRaw = String(orderReadyDue.value || "").trim();
    if (!dueRaw) throw new Error("Due date is required.");

    const dueDate = new Date(dueRaw);
    if (Number.isNaN(dueDate.getTime())) throw new Error("Invalid due date.");
    const dueAt = Timestamp.fromDate(dueDate);

    const ops = await getItemOpsInOrder(itemCode);
    const stationId = ops[0].code; // first op code, since you use stationId = OPCODE
const jobsRef = collection(db, "stations", stationId, "jobs");
await addDoc(jobsRef, {
  companyId,
  itemCode,
  orderNo,
  qty,
  dueAt,
  ops,
  currentOpIndex: 0,
  currentOpCode: ops[0].code,
  status: "ready",
  createdBy: getUserIdentifier(),
  createdAt: serverTimestamp(),
  updatedAt: serverTimestamp(),
});
  }

  confirmOrderReady?.addEventListener("click", async () => {
    if (!pendingOrderReady?.code) return;

    confirmOrderReady.disabled = true;
    orderReadyStatus.textContent = "Sending…";

    try{
      await sendOrderToOperators(pendingOrderReady);
      orderReadyStatus.textContent = "Sent!";
      setTimeout(closeOrderReadyModalFn, 350);
    } catch(err){
      console.error(err);
      orderReadyStatus.textContent = err?.message || "Failed to send.";
    } finally{
      confirmOrderReady.disabled = false;
    }
  });

  if (dropzone){
    dropzone.addEventListener("dragenter", (e) => { e.preventDefault(); dropzone.classList.add("drop-active"); });
    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("drop-active");
      e.dataTransfer.dropEffect = "copy";
    });
    dropzone.addEventListener("dragleave", (e) => {
      if (e.relatedTarget && dropzone.contains(e.relatedTarget)) return;
      dropzone.classList.remove("drop-active");
    });
    dropzone.addEventListener("drop", async (e) => {
      e.preventDefault();
      dropzone.classList.remove("drop-active");

      const payload = readDragPayload(e.dataTransfer);
      if (!payload?.code) return;

      openOrderReadyModal(payload);
    });
  }

  // ---------- ESC closes topmost modal ----------
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;

    if (deleteItemModal.classList.contains("open")) closeDeleteModal();
    else if (editItemModal.classList.contains("open")) closeEditItemModalFn();
    else if (addMemberModal.classList.contains("open")) closeAddMemberModalFn();
    else if (newItemModal.classList.contains("open")) closeNewItemModalFn();
    else if (newOpModal.classList.contains("open")) closeNewOpModalFn();
    else if (orderReadyModal.classList.contains("open")) closeOrderReadyModalFn();
  });
</script>
</body>
</html>
