<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ProdAlign | Select Station</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Select a station to open the workflow dashboard." />
  <style>
    :root{
      --accent:#e53935;
      --flame:#ff4b2b;
      --bg: radial-gradient(circle at 30% 25%, rgba(255, 120, 0, 0.25), transparent 40%),
            radial-gradient(circle at 70% 70%, rgba(0, 60, 140, 0.4), transparent 50%),
            linear-gradient(135deg, #0b1d2a, #102c44, #07131f);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);color:#fff}
    .card{width:min(460px,92vw);background:rgba(255,255,255,.08);backdrop-filter:blur(16px);border-radius:18px;padding:32px;box-shadow:0 25px 50px rgba(0,0,0,.5)}
    h2{margin:0 0 8px 0;font-weight:900;letter-spacing:.2px;color:var(--flame);text-align:center}
    p{margin:0 0 18px 0;opacity:.82;text-align:center;line-height:1.35}
    label{display:block;font-size:.85rem;margin:12px 0 6px;color:rgba(255,255,255,.85)}
    input{width:100%;padding:12px;border-radius:10px;border:none;font-size:1rem}
    input:focus{outline:2px solid var(--accent)}
    button{margin-top:16px;width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(135deg,#ff4b2b,#e53935);color:#fff;font-size:1rem;font-weight:800;cursor:pointer;transition:box-shadow .2s ease,transform .05s ease}
    button:hover{box-shadow:0 8px 20px rgba(255,75,43,.4)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:14px;padding:10px 12px;border-radius:10px;background:rgba(0,0,0,.25);font-size:.92rem;line-height:1.35;display:none;white-space:pre-line}
    .msg.show{display:block}
    .row{margin-top:14px;display:flex;justify-content:space-between;gap:12px;font-size:.9rem;opacity:.85}
    a{color:#fff;opacity:.9;text-decoration:none}
    a:hover{opacity:1;text-decoration:underline}
    .tiny{margin-top:16px;opacity:.6;font-size:.8rem;text-align:center}
  </style>
</head>
<body>
  <div class="card">
    <h2>Select Station</h2>
    <p>Enter the station PIN to open the correct workflow dashboard.</p>

    <form id="pinForm">
      <label for="pin">Station PIN</label>
      <input id="pin" required inputmode="numeric" autocomplete="one-time-code" placeholder="e.g. 1234" />

      <label for="op">Operator name (optional)</label>
      <input id="op" autocomplete="off" placeholder="e.g. Dave / Night shift" />

      <button id="goBtn" type="submit">Open Station</button>
    </form>

    <div id="msg" class="msg"></div>

    <div class="row">
      <a href="javascript:void(0)" id="clearLink">Clear station</a>
      <a href="javascript:void(0)" id="logoutLink">Log out</a>
    </div>

    <div class="tiny">© 2026 ProdAlign Ltd.</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs,
      doc, getDoc, setDoc, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD-ArzjlwKTZVpsH4ERg7n-MEgzCt6Nzno",
      authDomain: "prodalign-ltd.firebaseapp.com",
      projectId: "prodalign-ltd",
      storageBucket: "prodalign-ltd.firebasestorage.app",
      messagingSenderId: "899967683787",
      appId: "1:899967683787:web:b83544276739e1adcc1f4e",
      measurementId: "G-PCJSZYMHYQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const form = document.getElementById("pinForm");
    const pinEl = document.getElementById("pin");
    const opEl = document.getElementById("op");
    const msgEl = document.getElementById("msg");
    const goBtn = document.getElementById("goBtn");
    const logoutLink = document.getElementById("logoutLink");
    const clearLink = document.getElementById("clearLink");

    function showMsg(text) {
      msgEl.textContent = text;
      msgEl.classList.add("show");
    }
    function clearMsg() {
      msgEl.textContent = "";
      msgEl.classList.remove("show");
    }
    function setLoading(isLoading) {
      goBtn.disabled = isLoading;
      goBtn.textContent = isLoading ? "Checking..." : "Open Station";
    }

    function qs(name){
      return new URLSearchParams(location.search).get(name) || "";
    }

    // company code passed from login page: ?c=acme
    const companyCodeFromUrl = qs("c").trim().toLowerCase();

    // ✅ Stable per-device id (stored in browser)
    function getKioskDeviceId() {
      let id = localStorage.getItem("kioskDeviceId");
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem("kioskDeviceId", id);
      }
      return id;
    }

    function getSessionId(uid) {
      return `${uid}_${getKioskDeviceId()}`;
    }

    async function getUserCompany(uid) {
      const snap = await getDoc(doc(db, "users", uid));
      if (!snap.exists()) return "";
      const d = snap.data();
      return String(d.companycode ?? d.companyCode ?? "").trim().toLowerCase();
    }

    async function tryAutoResume(uid, companyCode) {
      const sessionId = getSessionId(uid);
      const sessSnap = await getDoc(doc(db, "kioskSessions", sessionId));
      if (!sessSnap.exists()) return false;

      const sess = sessSnap.data();
      const stationId = String(sess.stationId || "").trim();
      const sessCompany = String(sess.companyId || "").trim().toLowerCase();

      if (!stationId) return false;
      if (sessCompany !== companyCode) return false;

      location.assign(`/company/FloorDashboard.html?c=${encodeURIComponent(companyCode)}&station=${encodeURIComponent(stationId)}`);
      return true;
    }

    async function setSession(uid, companyCode, stationId, operatorLabel) {
      const sessionId = getSessionId(uid);
      await setDoc(doc(db, "kioskSessions", sessionId), {
        companyId: companyCode,
        stationId,
        operatorLabel: operatorLabel || null,
        updatedAt: serverTimestamp(),
      }, { merge: true });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.assign("/companylogin/");
        return;
      }

      clearMsg();

      let companyCode = companyCodeFromUrl;
      if (!companyCode) companyCode = await getUserCompany(user.uid);

      if (!companyCode) {
        showMsg("No company code found for this account.");
        return;
      }

      // If this device already selected a station previously, auto-open it
      await tryAutoResume(user.uid, companyCode);
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMsg();
      setLoading(true);

      try {
        const user = auth.currentUser;
        if (!user) throw new Error("Not signed in.");

        let companyCode = companyCodeFromUrl;
        if (!companyCode) companyCode = await getUserCompany(user.uid);
        if (!companyCode) throw new Error("Missing company code.");

        const pin = pinEl.value.trim();
        const operatorLabel = opEl.value.trim();

        // V1: plaintext PIN match in Firestore
        const q = query(
          collection(db, "stations"),
          where("companyId", "==", companyCode),
          where("pin", "==", pin),
          where("active", "==", true)
        );

        const snap = await getDocs(q);
        if (snap.empty) throw new Error("Invalid PIN.");

        const stationId = snap.docs[0].id;

        await setSession(user.uid, companyCode, stationId, operatorLabel);

        location.assign(`/company/FloorDashboard.html?c=${encodeURIComponent(companyCode)}&station=${encodeURIComponent(stationId)}`);

      } catch (err) {
        console.error(err);
        showMsg(err?.message || "Something went wrong.");
      } finally {
        setLoading(false);
      }
    });

    clearLink.addEventListener("click", async (e) => {
      e.preventDefault();
      clearMsg();

      try {
        const user = auth.currentUser;
        if (!user) return;

        const sessionId = getSessionId(user.uid);
        await deleteDoc(doc(db, "kioskSessions", sessionId));

        showMsg("Station cleared. Enter a PIN to continue.");
      } catch (err) {
        console.error(err);
        showMsg("Could not clear station.");
      }
    });

    logoutLink.addEventListener("click", async (e) => {
      e.preventDefault();
      await signOut(auth);
      location.assign("/companylogin/");
    });
  </script>
</body>
</html>
