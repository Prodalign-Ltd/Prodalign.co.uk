<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Company Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0b1d2a;
      color: #fff;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: #102c44;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .brand img {
      height: 44px;
      max-width: 220px;
      object-fit: contain;
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      padding: 6px;
      display: none; /* show when loaded */
    }

    .brand .name {
      font-weight: 800;
      font-size: 1.05rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 60vw;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.10);
      color: #fff;
      cursor: pointer;
      font-weight: 700;
    }
    button:hover { background: rgba(255,255,255,0.16); }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: auto 1fr;
      gap: 16px;
      padding: 16px;
      height: calc(100vh - 73px); /* header height approx */
      box-sizing: border-box;
    }

    .panel {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 14px;
    }

    .panel h2 {
      margin: 0 0 10px 0;
      font-size: 1rem;
    }

    /* Top area: Create Parts */
    #createParts {
      grid-column: 1 / span 2;
      grid-row: 1;
      min-height: 140px;
    }

    /* Bottom-left: Dropzone */
    #dropzone {
      grid-column: 1;
      grid-row: 2;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 220px;
      border-style: dashed;
      border-width: 2px;
      border-color: rgba(255,255,255,0.20);
      text-align: center;
      opacity: 0.95;
    }

    /* Bottom-right: placeholder content area */
    #mainArea {
      grid-column: 2;
      grid-row: 2;
      min-height: 220px;
    }

    .small {
      opacity: 0.8;
      font-size: 0.9rem;
      line-height: 1.35;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        height: auto;
      }
      #createParts { grid-column: 1; }
      #dropzone { grid-column: 1; grid-row: 2; }
      #mainArea { grid-column: 1; grid-row: 3; }
      .brand .name { max-width: 50vw; }
    }
  </style>
</head>

<body>

<header>
  <div class="brand">
    <img id="companyLogo" alt="Company Logo" />
    <div class="name" id="companyName">Loading...</div>
  </div>

  <div class="actions">
    <button id="settingsBtn" type="button">Settings</button>
    <button id="logoutBtn" type="button">Log out</button>
  </div>
</header>

<div class="layout">

  <div id="createParts" class="panel">
    <h2>Create Parts</h2>
    <div class="small">
      Placeholder area for your “create parts” flow (forms/buttons/tables).<br/>
      We’ll wire this up next.
    </div>
  </div>

  <div id="dropzone" class="panel">
    <h2 style="margin-bottom:6px;">Dropzone</h2>
    <div class="small">
      Drag &amp; drop files here (we’ll hook to Firebase Storage later).
    </div>
  </div>

  <div id="mainArea" class="panel">
    <h2>Main Area</h2>
    <div class="small">
      Placeholder for dashboards, lists, operator view, etc.
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD-ArzjlwKTZVpsH4ERg7n-MEgzCt6Nzno",
    authDomain: "prodalign-ltd.firebaseapp.com",
    projectId: "prodalign-ltd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const companyLogoEl = document.getElementById("companyLogo");
  const companyNameEl = document.getElementById("companyName");
  const logoutBtn = document.getElementById("logoutBtn");
  const settingsBtn = document.getElementById("settingsBtn");

  // Company id from URL
  const params = new URLSearchParams(window.location.search);
  const companyId = (params.get("c") || "").trim().toLowerCase();

  if (!companyId) {
    companyNameEl.textContent = "Missing company id (?c=...)";
    // You can redirect somewhere else if you want:
    // window.location.assign("/companylogin/");
    throw new Error("Missing ?c=");
  }

  async function loadCompanyBranding(companyId) {
    const snap = await getDoc(doc(db, "companies", companyId));
    if (!snap.exists()) {
      companyNameEl.textContent = `Company '${companyId}' not found`;
      return;
    }

    const company = snap.data();
    const name = company.displayname || "Company";
    const logoUrl = company.Logourl || "";

    companyNameEl.textContent = name;

    if (logoUrl) {
      companyLogoEl.src = logoUrl;
      companyLogoEl.style.display = "block";
    }

    document.title = `${name} | Dashboard`;
  }

  async function enforceUserCompany(user, companyId) {
    const userSnap = await getDoc(doc(db, "users", user.uid));
    if (!userSnap.exists()) throw new Error("User profile missing (users/{uid}).");

    const data = userSnap.data();
    const userCompany = String(data.companycode ?? data.companyCode ?? "").trim().toLowerCase();

    if (!userCompany) throw new Error("User profile missing companycode.");
    if (userCompany !== companyId) throw new Error("Access denied for this company.");

    // If you want role later:
    // const role = String(data.role ?? "user").toLowerCase();
    // return role;

    return true;
  }

  // Auth gate
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
      return;
    }

    try {
      await enforceUserCompany(user, companyId);
      await loadCompanyBranding(companyId);
    } catch (err) {
      console.error(err);
      // If logged in but wrong company, sign out and go to login
      try { await signOut(auth); } catch {}
      window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
    }
  });

  // Logout
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
  });

  // Settings placeholder
  settingsBtn.addEventListener("click", () => {
    alert("Settings (to be wired later)");
  });
</script>

</body>
</html>
