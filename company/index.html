<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Company Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0b1d2a;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .card {
      background: #102c44;
      padding: 40px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 8px;
      border: none;
    }

    button {
      background: #e53935;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .msg {
      margin-top: 15px;
      font-size: 0.9rem;
      color: #ff8080;
    }

    .logout {
      margin-top: 15px;
      font-size: 0.85rem;
      opacity: 0.8;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div class="card">
    <h2>Company Login</h2>

    <form id="loginForm">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>

    <div class="msg" id="message"></div>
    <div class="logout" id="logoutBtn">Log out</div>
  </div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD-ArzjlwKTZVpsH4ERg7n-MEgzCt6Nzno",
  authDomain: "prodalign-ltd.firebaseapp.com",
  projectId: "prodalign-ltd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const companyId = (params.get("c") || "").toLowerCase();

if (!companyId) {
  document.body.innerHTML = "No company specified.";
  throw new Error("Missing ?c=");
}

const messageEl = document.getElementById("message");

function showError(text) {
  messageEl.textContent = text;
}

// Redirect if already logged in
onAuthStateChanged(auth, async (user) => {
  if (!user) return;

  try {
    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) throw new Error("User profile missing.");

    const data = snap.data();
    const userCompany = (data.companycode || "").toLowerCase();

    if (userCompany !== companyId) {
      await signOut(auth);
      showError("Wrong company.");
      return;
    }

    window.location.href = `/dashboard/?c=${companyId}`;

  } catch (err) {
    showError("Access check failed.");
  }
});

// Login submit
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  showError("");

  try {
    const email = document.getElementById("email").value.trim();
    const pass = document.getElementById("password").value;

    const cred = await signInWithEmailAndPassword(auth, email, pass);

    const snap = await getDoc(doc(db, "users", cred.user.uid));
    const data = snap.data();

    if (!snap.exists() || (data.companycode || "").toLowerCase() !== companyId) {
      await signOut(auth);
      showError("You do not belong to this company.");
      return;
    }

    window.location.href = `/dashboard/?c=${companyId}`;

  } catch (err) {
    showError("Login failed.");
  }
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  showError("Logged out.");
});

</script>
</body>
</html>
