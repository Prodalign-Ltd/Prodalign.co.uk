<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Production Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#071826;
      --text:#fff;
      --muted:rgba(255,255,255,.78);
      --panel:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.10);
      --orange:#f57c00;
      --red:#d32f2f;
      --radius:16px;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      min-height:100vh;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(245,124,0,0.18), transparent 60%),
        radial-gradient(900px 600px at 110% 10%, rgba(211,47,47,0.12), transparent 55%),
        linear-gradient(180deg, var(--bg) 0%, #06131e 100%);
      display:flex;
      flex-direction:column;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      background: linear-gradient(90deg, rgba(16,44,68,0.95), rgba(9,27,42,0.92));
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{
      height:44px; max-width:220px; object-fit:contain;
      border-radius:10px; background:rgba(255,255,255,0.06);
      padding:6px; display:none;
      border:1px solid rgba(245,124,0,0.20);
    }
    .brand .name{
      font-weight:900;font-size:1.05rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:56vw;
    }
    .actions{display:flex;gap:10px;align-items:center}
    button{
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(255,255,255,0.08);
      color:#fff;
      cursor:pointer;
      font-weight:800;
    }
    button:hover{ background:rgba(255,255,255,0.12); border-color:rgba(245,124,0,0.35); }
    .btn-danger{ border-color:rgba(211,47,47,0.40); }

    .wrap{
      flex:1;
      display:grid;
      place-items:start center;
      padding:22px;
    }

    .stack{
      display:flex;
      flex-direction:column;
      gap:18px;
      align-items:center;
      width:100%;
      max-width: 1100px;
    }

    .hero{
      width:min(980px, 96vw);
      text-align:center;
      margin-bottom:6px;
    }
    .hero h1{
      margin:10px 0 0;
      font-size:clamp(28px, 4vw, 44px);
      letter-spacing:.3px;
      text-shadow: 0 8px 30px rgba(0,0,0,.45);
    }

    .board{
      width:min(1040px, 96vw);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      box-shadow: var(--shadow);
      padding:20px 18px 22px;
    }
    .board h2{
      margin: 4px 0 18px;
      font-size: 22px;
      font-weight: 900;
      text-shadow: 0 8px 30px rgba(0,0,0,.35);
    }

    .tiles{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:16px;
    }
    .tile{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding:18px 16px;
      cursor:pointer;
      user-select:none;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
      min-height: 120px;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      align-items:flex-start;
      gap:10px;
    }
    .tile:hover{
      transform: translateY(-2px);
      border-color: rgba(245,124,0,0.35);
      background: rgba(255,255,255,0.08);
    }
    .icon{
      width:54px;height:54px;border-radius:14px;
      display:grid;place-items:center;
      background: rgba(0,0,0,0.20);
      border:1px solid rgba(255,255,255,0.10);
      color: #7ee6ff;
      font-weight: 950;
      font-size: 20px;
    }
    .tile .label{ font-weight: 900; font-size: 18px; }
    .tile .sub{ color: var(--muted); font-size: 13px; margin-top:-6px; }
    .tile[hidden]{ display:none !important; }

    /* Orders to Book strip */
    .ordersStrip{
      width:min(1040px, 96vw);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      box-shadow: var(--shadow);
      padding:16px 16px 14px;
    }
    .ordersStripHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .ordersStripHeader h2{
      margin:0;
      font-size: 20px;
      font-weight: 900;
      text-shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    .ordersStripHeader .hint{
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
    }

    .ordersRow{
      display:flex;
      gap:12px;
      overflow-x:auto;
      padding-bottom:6px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .ordersRow::-webkit-scrollbar{ height:10px; }
    .ordersRow::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,0.10);
      border-radius: 999px;
    }

    .jobCard{
      flex: 0 0 auto;
      width: 230px;
      min-height: 92px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      padding:14px 14px 12px;
      cursor:pointer;
      scroll-snap-align:start;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .jobCard:hover{
      transform: translateY(-2px);
      border-color: rgba(245,124,0,0.35);
      background: rgba(255,255,255,0.08);
    }
    .jobTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pill{
      font-size: 11px;
      font-weight: 900;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(245,124,0,0.14);
      border: 1px solid rgba(245,124,0,0.25);
      color: rgba(255,255,255,0.92);
      white-space:nowrap;
    }
    .jobNo{
      font-weight: 950;
      letter-spacing: .2px;
    }
    .jobSub{
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      line-height: 1.25;
    }

    /* Operations grid */
    .opsGrid{
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 12px;
    }
    .opsBtn{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding:14px 12px;
      cursor:pointer;
      user-select:none;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
      min-height: 120px;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      align-items:flex-start;
      gap:10px;
    }
    .opsBtn:hover{
      transform: translateY(-2px);
      border-color: rgba(245,124,0,0.35);
      background: rgba(255,255,255,0.08);
    }
    .opsBtn .label{ font-weight: 900; font-size: 14px; }
    .opsBtn .sub{ color: var(--muted); font-size: 12px; margin-top:-6px; }

    @media (max-width: 1100px){
      .opsGridWrap{
        overflow-x:auto;
        padding-bottom:6px;
      }
      .opsGrid{ width: 1200px; }
    }
    @media (max-width: 980px){
      .tiles{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      .tiles{ grid-template-columns: 1fr; }
      .brand .name{ max-width: 48vw; }
      .jobCard{ width: 200px; }
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <img id="companyLogo" alt="Company Logo" />
    <div class="name" id="companyName">Loading...</div>
  </div>

  <div class="actions">
    <button id="logoutBtn" class="btn-danger" type="button">Log out</button>
  </div>
</header>

<div class="wrap">
  <div class="stack">

    <div class="hero">
      <h1>Production Overview</h1>
      <div style="color:var(--muted); font-weight:800; margin-top:6px;">
        Production Overview (Past 30 Days)
      </div>
    </div>

    <section class="ordersStrip">
      <div class="ordersStripHeader">
        <h2>Orders to Book</h2>
        <div class="hint" id="ordersHint">Loading‚Ä¶</div>
      </div>

      <div class="ordersRow" id="ordersRow">
        <div class="jobSub" style="padding:8px 6px;">Loading‚Ä¶</div>
      </div>
    </section>

    <div class="board">
      <h2>Production Overview (Past 30 Days)</h2>

      <div class="tiles">
        <div class="tile" id="deliveryTile">
          <div class="icon">üì¶</div>
          <div class="label">Delivery Performance</div>
          <div class="sub">Template tile</div>
        </div>

        <div class="tile" id="scrapTile">
          <div class="icon">üß©</div>
          <div class="label">Scrap Reasons</div>
          <div class="sub">Template tile</div>
        </div>

        <!-- ‚úÖ NEW: Company Workspace (admin only) -->
        <div class="tile" id="workspaceTile" hidden>
          <div class="icon" style="color:#ffd08a;">üè¢</div>
          <div class="label">Company Workspace</div>
          <div class="sub">Settings & admin tools</div>
        </div>

        <div class="tile" id="ordersDueTile">
          <div class="icon">üìÑ</div>
          <div class="label">Orders Due</div>
          <div class="sub">Go to Orders Due</div>
        </div>
      </div>
    </div>

    <div class="board">
      <h2>Operations Overview</h2>
      <div class="opsGridWrap">
        <div class="opsGrid" id="opsGrid"></div>
      </div>
    </div>

  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc,
    collection, query, where, onSnapshot, limit
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD-ArzjlwKTZVpsH4ERg7n-MEgzCt6Nzno",
    authDomain: "prodalign-ltd.firebaseapp.com",
    projectId: "prodalign-ltd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM
  const companyLogoEl = document.getElementById("companyLogo");
  const companyNameEl = document.getElementById("companyName");
  const logoutBtn = document.getElementById("logoutBtn");

  const deliveryTile = document.getElementById("deliveryTile");
  const scrapTile = document.getElementById("scrapTile");
  const workspaceTile = document.getElementById("workspaceTile");
  const ordersDueTile = document.getElementById("ordersDueTile");

  const ordersRow = document.getElementById("ordersRow");
  const ordersHint = document.getElementById("ordersHint");
  const opsGrid = document.getElementById("opsGrid");

  // URL param
  const params = new URLSearchParams(window.location.search);
  const companyId = (params.get("c") || "").trim().toLowerCase();

  if (!companyId) {
    companyNameEl.textContent = "Missing company id (?c=...)";
    throw new Error("Missing ?c=");
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  async function loadCompanyBranding(companyId) {
    const snap = await getDoc(doc(db, "companies", companyId));
    if (!snap.exists()) {
      companyNameEl.textContent = `Company '${companyId}' not found`;
      return;
    }
    const company = snap.data();
    companyNameEl.textContent = company.displayname || company.companyname || "Company";

    const logoUrl = company.Logourl || company.logoUrl || "";
    if (logoUrl) {
      companyLogoEl.src = logoUrl;
      companyLogoEl.style.display = "block";
    }
    document.title = `${companyNameEl.textContent} | Production Overview`;
  }

  async function getUserProfile(user) {
    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) throw new Error("User profile missing.");
    return snap.data();
  }

  function normalizeCompanyCode(data) {
    return String(data.companycode ?? data.companyCode ?? "").trim().toLowerCase();
  }
  function normalizeRole(data) {
    return String(data.role ?? "").trim().toLowerCase();
  }
  function normalizeStation(data) {
    return String(data.station ?? "").trim().toLowerCase();
  }

  function buildOpsGrid() {
    const total = 40;
    const frag = document.createDocumentFragment();

    for (let i = 1; i <= total; i++) {
      const btn = document.createElement("div");
      btn.className = "opsBtn";
      btn.innerHTML = `
        <div class="icon">‚öôÔ∏è</div>
        <div class="label">Op ${i}</div>
        <div class="sub">Template button</div>
      `;
      btn.addEventListener("click", () => alert(\`Operations Overview: Op ${i} (template)\`));
      frag.appendChild(btn);
    }

    opsGrid.innerHTML = "";
    opsGrid.appendChild(frag);
  }

  function renderOrdersToBook(jobs){
    ordersHint.textContent = jobs.length ? `Showing ${jobs.length} job(s)` : "No jobs waiting to be booked";

    if (!jobs.length){
      ordersRow.innerHTML = `<div class="jobSub" style="padding:8px 6px;">No orders to book.</div>`;
      return;
    }

    ordersRow.innerHTML = jobs.map(j => {
      const jobNo = escapeHtml(j.orderNo || j.id || "JOB");
      const qty = Number(j.qty || 0);
      const item = escapeHtml(String(j.itemCode || "").toUpperCase());

      return `
        <div class="jobCard" data-job="${escapeHtml(j.id)}">
          <div class="jobTop">
            <div class="jobNo">${jobNo}</div>
            <div class="pill">To book</div>
          </div>
          <div class="jobSub">Item: ${item}<br/>Qty: ${qty}</div>
        </div>
      `;
    }).join("");
  }

  function watchOrdersToBook(){
    const jobsRef = collection(db, "companies", companyId, "jobs");
    const q = query(jobsRef, where("status", "==", "to_book"), limit(50));

    return onSnapshot(q, (snap) => {
      const jobs = [];
      snap.forEach(d => jobs.push({ id: d.id, ...(d.data() || {}) }));
      renderOrdersToBook(jobs);
    }, (err) => {
      console.error("Orders to book listener error:", err);
      ordersHint.textContent = "Error";
      ordersRow.innerHTML = `<div class="jobSub" style="padding:8px 6px;">
        Error loading orders to book: ${escapeHtml(err.message)}
      </div>`;
    });
  }

  function applyOverviewLockdown() {
    document.querySelectorAll(".tile, .opsBtn, .jobCard").forEach((el) => {
      el.style.pointerEvents = "none";
      el.style.opacity = "0.90";
    });
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.assign(`/companylogin/`);
      return;
    }

    try {
      const profile = await getUserProfile(user);

      const userCompany = normalizeCompanyCode(profile);
      if (!userCompany || userCompany !== companyId) throw new Error("Access denied for this company.");

      const role = normalizeRole(profile);
      const station = normalizeStation(profile);

      // Operator redirect
      if (role === "operator") {
        if (!station) throw new Error("Operator missing station.");
        window.location.assign(
          `/company/FloorDashboard.html?c=${encodeURIComponent(companyId)}&station=${encodeURIComponent(station)}`
        );
        return;
      }

      await loadCompanyBranding(companyId);

      // Admin-only tile visibility
      const license = String(profile.license ?? "").trim().toLowerCase();
      const isAdmin = Boolean(profile.isAdmin) || role === "admin" || license === "admin";
      workspaceTile.hidden = !isAdmin;

      // UI
      buildOpsGrid();
      watchOrdersToBook();

      // Overview view-only mode
      if (role === "overview") {
        applyOverviewLockdown();
      }

    } catch (e) {
      console.error(e);
      try { await signOut(auth); } catch {}
      window.location.assign(`/companylogin/`);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    try { await signOut(auth); } catch {}
    window.location.assign(`/companylogin/`);
  });

  // ‚úÖ Company Workspace tile click (same destination as old settings)
  workspaceTile.addEventListener("click", () => {
    window.location.assign(`/company/settings.html?c=${encodeURIComponent(companyId)}`);
  });

  deliveryTile.addEventListener("click", () => alert("Delivery Performance (template)"));
  scrapTile.addEventListener("click", () => alert("Scrap Reasons (template)"));

  ordersDueTile.addEventListener("click", () => {
    window.location.assign(`/company/Ordersdue.html?c=${encodeURIComponent(companyId)}`);
  });
</script>
</body>
</html>
