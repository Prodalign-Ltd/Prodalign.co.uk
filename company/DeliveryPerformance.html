<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Delivery Performance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg:#071826;
      --panel:rgba(255,255,255,0.06);
      --border:rgba(255,255,255,0.10);
      --text:#fff;
      --muted:rgba(255,255,255,0.75);
      --orange:#f57c00;
      --radius:14px;

      --good:#2ecc71;
      --bad:#d32f2f;
      --shadow: 0 18px 55px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(245,124,0,0.18), transparent 60%),
        radial-gradient(900px 600px at 120% 0%, rgba(211,47,47,0.12), transparent 55%),
        linear-gradient(180deg, var(--bg) 0%, #06131e 100%);
      color: var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 18px;
      background: linear-gradient(90deg, rgba(16,44,68,0.95), rgba(9,27,42,0.92));
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      gap: 12px;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .brand img{
      height: 44px; max-width: 220px; object-fit: contain;
      border-radius: 10px; background: rgba(255,255,255,0.06);
      padding: 6px; display:none;
      border: 1px solid rgba(245,124,0,0.20);
    }
    .brand .name{
      font-weight: 900; font-size: 1.05rem;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: 56vw; letter-spacing: 0.2px;
    }

    .actions{ display:flex; align-items:center; gap: 10px; flex:0 0 auto; }

    button{
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.08);
      color: #fff;
      cursor: pointer;
      font-weight: 800;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    button:hover{
      background: rgba(255,255,255,0.12);
      border-color: rgba(245,124,0,0.35);
      transform: translateY(-1px);
    }
    .btn-danger{
      border-color: rgba(211,47,47,0.40);
      background: linear-gradient(180deg, rgba(211,47,47,0.18), rgba(255,255,255,0.08));
    }

    .wrap{
      padding: 14px;
      flex: 1;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }

    .panel-header{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), transparent);
    }

    .panel-title{
      font-weight: 900;
      font-size: 0.92rem;
      letter-spacing: 0.2px;
      opacity: 0.95;
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .panel-title .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--orange);
      box-shadow: 0 0 0 4px rgba(245,124,0,0.15);
      display:inline-block;
    }

    .hint{
      color: var(--muted);
      font-weight: 800;
      font-size: 0.9rem;
      line-height: 1.35;
      white-space: nowrap;
    }

    .panel-body{
      padding: 14px 12px;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .chartWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      align-items:center;
      justify-items:center;
    }

    .donutCard{
      width: min(520px, 92vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      padding: 14px;
      box-shadow: var(--shadow);
      display:grid;
      place-items:center;
    }

    #donutSvg{
      width: min(420px, 80vw);
      height: auto;
      display:block;
    }

    .legend{
      width: min(520px, 92vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      padding: 14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      box-shadow: 0 12px 34px rgba(0,0,0,.18);
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-weight: 900;
    }
    .left{
      display:flex; align-items:center; gap: 10px;
      min-width:0;
    }
    .swatch{
      width: 14px; height: 14px; border-radius: 5px;
      border: 1px solid rgba(255,255,255,0.18);
      flex: 0 0 auto;
    }
    .label{
      color: rgba(255,255,255,0.92);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .val{
      color: rgba(255,255,255,0.92);
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }
    .mutedLine{
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
      line-height: 1.35;
    }

    /* === Lists === */
    .listsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      min-height: 0;
    }
    @media (max-width: 980px){
      .brand .name{ max-width: 48vw; }
      .listsGrid{ grid-template-columns: 1fr; }
    }

    .listCard{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      box-shadow: 0 12px 34px rgba(0,0,0,.18);
      overflow:hidden;
      min-height: 240px;
      display:flex;
      flex-direction:column;
    }

    .listHead{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight: 950;
    }
    .listHead.good{
      background: linear-gradient(180deg, rgba(46,204,113,0.18), rgba(0,0,0,0));
    }
    .listHead.bad{
      background: linear-gradient(180deg, rgba(211,47,47,0.20), rgba(0,0,0,0));
    }

    .countPill{
      font-size: 11px;
      font-weight: 950;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      white-space:nowrap;
    }

    .listBody{
      padding: 10px 10px 12px;
      overflow:auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .miniRow{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      padding: 10px 10px 9px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .miniTop{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .ord{
      font-weight: 950;
      letter-spacing: .2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70%;
    }
    .qty{
      font-weight: 950;
      color: rgba(255,255,255,0.92);
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }
    .miniSub{
      color: var(--muted);
      font-weight: 850;
      font-size: 12px;
      line-height: 1.25;
      display:flex;
      flex-wrap:wrap;
      gap: 8px 12px;
    }
    .tag{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      padding: 3px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <img id="companyLogo" alt="Company Logo" />
      <div class="name" id="companyName">Loading…</div>
    </div>

    <div class="actions">
      <button id="backBtn" type="button">Back</button>
      <button id="logoutBtn" class="btn-danger" type="button">Log out</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title"><span class="dot"></span> Delivery Performance</div>
        <div class="hint" id="statusText">Loading…</div>
      </div>

      <div class="panel-body">
        <div class="chartWrap">
          <div class="donutCard">
            <svg id="donutSvg" viewBox="0 0 220 220" role="img" aria-label="Delivery performance chart"></svg>
          </div>

          <div class="legend">
            <div class="row">
              <div class="left">
                <span class="swatch" style="background: var(--good);"></span>
                <span class="label">On time / Early</span>
              </div>
              <span class="val" id="goodText">—</span>
            </div>

            <div class="row">
              <div class="left">
                <span class="swatch" style="background: var(--bad);"></span>
                <span class="label">Late</span>
              </div>
              <span class="val" id="badText">—</span>
            </div>

            <div class="mutedLine" id="footnote">
              Late = booked into stock AFTER due date.
            </div>
          </div>
        </div>

        <!-- ✅ NEW: two lists underneath -->
        <div class="listsGrid">
          <div class="listCard">
            <div class="listHead good">
              <div>On time booked</div>
              <div class="countPill" id="goodCountPill">0</div>
            </div>
            <div class="listBody" id="goodList">
              <div class="mutedLine">Loading…</div>
            </div>
          </div>

          <div class="listCard">
            <div class="listHead bad">
              <div>Overdue booked</div>
              <div class="countPill" id="badCountPill">0</div>
            </div>
            <div class="listBody" id="badList">
              <div class="mutedLine">Loading…</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, onSnapshot, query, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD-ArzjlwKTZVpsH4ERg7n-MEgzCt6Nzno",
      authDomain: "prodalign-ltd.firebaseapp.com",
      projectId: "prodalign-ltd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const companyId = (params.get("c") || "").trim().toLowerCase();

    const companyLogoEl = document.getElementById("companyLogo");
    const companyNameEl = document.getElementById("companyName");
    const statusText = document.getElementById("statusText");
    const logoutBtn = document.getElementById("logoutBtn");
    const backBtn = document.getElementById("backBtn");

    const donutSvg = document.getElementById("donutSvg");
    const goodText = document.getElementById("goodText");
    const badText = document.getElementById("badText");

    const goodList = document.getElementById("goodList");
    const badList = document.getElementById("badList");
    const goodCountPill = document.getElementById("goodCountPill");
    const badCountPill = document.getElementById("badCountPill");

    if (!companyId) {
      companyNameEl.textContent = "Missing company id (?c=...)";
      statusText.textContent = "Cannot load without ?c=";
      throw new Error("Missing ?c=");
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function asDateMaybe(v){
      if (!v) return null;
      if (v?.toDate) return v.toDate(); // Firestore Timestamp
      if (v instanceof Date) return v;
      const d = new Date(v);
      return Number.isNaN(d.getTime()) ? null : d;
    }

    // ✅ Adjust these to match YOUR schema if needed:
    function bookedDateFromJob(job){
      return (
        asDateMaybe(job.bookedAt) ||
        asDateMaybe(job.bookedIntoStockAt) ||
        asDateMaybe(job.bookedInAt) ||
        asDateMaybe(job.stockBookedAt) ||
        asDateMaybe(job.completedAt) ||
        null
      );
    }

    function dueDateFromJob(job){
      return asDateMaybe(job.dueAt) || null;
    }

    function jobOrderNo(job, fallbackId){
      return String(job.orderNo || job.orderno || job.order || fallbackId || "JOB").trim();
    }

    function jobPartNo(job){
      return String(job.itemCode || job.partNo || job.part || job.item || "").trim().toUpperCase();
    }

    function jobQty(job){
      const q = Number(job.qty ?? job.quantity ?? 0);
      if (!Number.isFinite(q) || q <= 0) return 0;
      return Math.floor(q);
    }

    function fmtDate(d){
      if (!d) return "—";
      // local YYYY-MM-DD
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function pct(n, d){
      if (!d) return 0;
      return Math.round((n / d) * 100);
    }

    // ===== Donut helpers =====
    function polarToCartesian(cx, cy, r, angleDeg){
      const a = (angleDeg - 90) * Math.PI / 180.0;
      return { x: cx + (r * Math.cos(a)), y: cy + (r * Math.sin(a)) };
    }
    function arcPath(cx, cy, r, startAngle, endAngle){
      const start = polarToCartesian(cx, cy, r, endAngle);
      const end = polarToCartesian(cx, cy, r, startAngle);
      const largeArcFlag = (endAngle - startAngle) <= 180 ? "0" : "1";
      return `M ${start.x} ${start.y} A ${r} ${r} 0 ${largeArcFlag} 0 ${end.x} ${end.y}`;
    }

    function renderDonut({ goodCount, badCount }){
      const total = goodCount + badCount;

      if (!total){
        donutSvg.innerHTML = `
          <circle cx="110" cy="110" r="86" fill="none" stroke="rgba(255,255,255,0.10)" stroke-width="26"></circle>
          <text x="110" y="106" text-anchor="middle" font-size="18" font-weight="950" fill="rgba(255,255,255,0.92)">No data</text>
          <text x="110" y="128" text-anchor="middle" font-size="11" font-weight="800" fill="rgba(255,255,255,0.65)">Need dueAt + bookedAt</text>
        `;
        goodText.textContent = "—";
        badText.textContent = "—";
        return;
      }

      const goodPct = pct(goodCount, total);
      const badPct = 100 - goodPct;

      const start = 0;
      const goodAngle = (goodCount / total) * 360;
      const goodEnd = start + goodAngle;
      const badEnd = 360;

      const goodStroke = getComputedStyle(document.documentElement).getPropertyValue("--good").trim() || "#2ecc71";
      const badStroke  = getComputedStyle(document.documentElement).getPropertyValue("--bad").trim()  || "#d32f2f";

      const isAllGood = badCount === 0;
      const isAllBad  = goodCount === 0;

      donutSvg.innerHTML = `
        <circle cx="110" cy="110" r="86" fill="none" stroke="rgba(255,255,255,0.10)" stroke-width="26"></circle>

        ${isAllGood ? `
          <circle cx="110" cy="110" r="86" fill="none" stroke="${goodStroke}" stroke-width="26" stroke-linecap="butt"></circle>
        ` : isAllBad ? `
          <circle cx="110" cy="110" r="86" fill="none" stroke="${badStroke}" stroke-width="26" stroke-linecap="butt"></circle>
        ` : `
          <path d="${arcPath(110,110,86, start, goodEnd)}" fill="none" stroke="${goodStroke}" stroke-width="26" stroke-linecap="butt"></path>
          <path d="${arcPath(110,110,86, goodEnd, badEnd)}" fill="none" stroke="${badStroke}" stroke-width="26" stroke-linecap="butt"></path>
        `}

        <circle cx="110" cy="110" r="62" fill="rgba(7,24,38,0.85)"></circle>

        <text x="110" y="108" text-anchor="middle" font-size="34" font-weight="950" fill="rgba(255,255,255,0.95)">${goodPct}%</text>
        <text x="110" y="132" text-anchor="middle" font-size="12" font-weight="900" fill="rgba(255,255,255,0.70)">On time</text>
      `;

      goodText.textContent = `${goodPct}% (${goodCount})`;
      badText.textContent = `${badPct}% (${badCount})`;
    }

    function renderJobList(container, items){
      if (!items.length){
        container.innerHTML = `<div class="mutedLine">No jobs found.</div>`;
        return;
      }

      container.innerHTML = items.map(j => {
        const orderNo = escapeHtml(j.orderNo);
        const partNo = escapeHtml(j.partNo);
        const qty = j.qty;

        return `
          <div class="miniRow">
            <div class="miniTop">
              <div class="ord">Order: ${orderNo}</div>
              <div class="qty">Qty: ${qty}</div>
            </div>
            <div class="miniSub">
              <span class="tag">Part: ${partNo || "—"}</span>
              <span class="tag">Due: ${escapeHtml(j.dueStr)}</span>
              <span class="tag">Booked: ${escapeHtml(j.bookedStr)}</span>
            </div>
          </div>
        `;
      }).join("");
    }

    async function loadCompanyBranding(companyId) {
      const snap = await getDoc(doc(db, "companies", companyId));
      if (!snap.exists()) {
        companyNameEl.textContent = `Company '${companyId}' not found`;
        return;
      }
      const company = snap.data() || {};
      const name = company.displayname || company.companyname || "Company";
      const logoUrl = company.Logourl || company.logoUrl || "";

      companyNameEl.textContent = name;
      if (logoUrl) {
        companyLogoEl.src = logoUrl;
        companyLogoEl.style.display = "block";
      }
      document.title = `${name} | Delivery Performance`;
    }

    async function enforceUserCompany(user, companyId) {
      const userSnap = await getDoc(doc(db, "users", user.uid));
      if (!userSnap.exists()) throw new Error("User profile missing (users/{uid}).");

      const data = userSnap.data() || {};
      const userCompany = String(data.companycode ?? data.companyCode ?? "").trim().toLowerCase();

      if (!userCompany) throw new Error("User profile missing companycode.");
      if (userCompany !== companyId) throw new Error("Access denied for this company.");
      return true;
    }

    function watchDeliveryPerformance(){
      const jobsRef = collection(db, "companies", companyId, "jobs");
      const qy = query(jobsRef, orderBy("dueAt", "desc"), limit(800));

      return onSnapshot(qy, (snap) => {
        const goodItems = [];
        const badItems = [];

        snap.forEach((ds) => {
          const data = ds.data() || {};

          const due = dueDateFromJob(data);
          const booked = bookedDateFromJob(data);
          if (!due || !booked) return;

          const qty = jobQty(data);
          const orderNo = jobOrderNo(data, ds.id);
          const partNo = jobPartNo(data);

          const model = {
            id: ds.id,
            orderNo,
            partNo,
            qty,
            dueStr: fmtDate(due),
            bookedStr: fmtDate(booked),
            dueMs: due.getTime(),
            bookedMs: booked.getTime()
          };

          if (model.bookedMs > model.dueMs) badItems.push(model);
          else goodItems.push(model);
        });

        // Sort: overdue worst first; on-time newest first (by booked date)
        badItems.sort((a, b) => (b.bookedMs - b.dueMs) - (a.bookedMs - a.dueMs));
        goodItems.sort((a, b) => b.bookedMs - a.bookedMs);

        // Update donut
        renderDonut({ goodCount: goodItems.length, badCount: badItems.length });

        // Update pills + lists (cap for performance)
        const cap = 200;
        goodCountPill.textContent = String(goodItems.length);
        badCountPill.textContent = String(badItems.length);

        renderJobList(goodList, goodItems.slice(0, cap));
        renderJobList(badList, badItems.slice(0, cap));

        const total = goodItems.length + badItems.length;
        statusText.textContent = total ? `Total booked: ${total}` : `No usable data yet`;
      }, (err) => {
        console.error(err);
        statusText.textContent = "Error";
        donutSvg.innerHTML = `
          <text x="110" y="110" text-anchor="middle" font-size="12" font-weight="900" fill="#ffb4b4">
            Error loading jobs
          </text>
        `;
        goodList.innerHTML = `<div class="mutedLine">Error loading.</div>`;
        badList.innerHTML = `<div class="mutedLine">Error loading.</div>`;
      });
    }

    logoutBtn.addEventListener("click", async () => {
      try { await signOut(auth); } catch {}
      window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
    });

    backBtn.addEventListener("click", () => {
      window.location.assign(`./index.html?c=${encodeURIComponent(companyId)}`);
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
        return;
      }

      try{
        await enforceUserCompany(user, companyId);
        await loadCompanyBranding(companyId);
        statusText.textContent = "Reading jobs…";
        watchDeliveryPerformance();
      } catch (err){
        console.error(err);
        statusText.textContent = "Access denied";
        try { await signOut(auth); } catch {}
        window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
      }
    });
  </script>
</body>
</html>
