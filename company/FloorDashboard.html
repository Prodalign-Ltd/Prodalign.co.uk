<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Station Dashboard</title>

  <style>
    :root{
      /* Modern “techy” palette */
      --bg0:#06121b;
      --bg1:#071a28;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.10);

      --text:#eaf2ff;
      --muted: rgba(234,242,255,.72);

      /* Status colors (kept close to your original meaning) */
      --wip:#2e7d32;
      --available:#f9a825;
      --overdue:#ef6c00;
      --na:#d32f2f;
      --pre:#0aa6b4;

      --radius: 16px;
      --radius2: 22px;
      --shadow: 0 20px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 24px rgba(0,0,0,.35);
      --glow: 0 0 0 1px rgba(255,255,255,.08) inset;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 650px at 12% -10%, rgba(249,168,37,.22), transparent 55%),
        radial-gradient(900px 550px at 105% 0%, rgba(211,47,47,.18), transparent 55%),
        radial-gradient(1000px 700px at 80% 120%, rgba(10,166,180,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    /* Subtle grid overlay */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(to right, rgba(255,255,255,.04) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.04) 1px, transparent 1px);
      background-size: 54px 54px;
      mask-image: radial-gradient(closest-side at 50% 20%, rgba(0,0,0,.9), transparent 70%);
      opacity:.22;
      z-index:0;
    }

    /* Top header */
    header{
      position:sticky;
      top:0;
      z-index:10;
      padding: 16px 16px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(6,18,27,.55);
      backdrop-filter: blur(14px);
    }

    .topbar{
      max-width: 1520px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 14px;
      align-items:center;
    }

    .leftActions, .rightActions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .leftActions{ justify-content:flex-start; }
    .rightActions{ justify-content:flex-end; }

    .titleWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .title{
      margin:0;
      font-weight: 950;
      letter-spacing: .2px;
      font-size: clamp(22px, 2.6vw, 40px);
      line-height: 1.05;
      text-shadow: 0 12px 40px rgba(0,0,0,.55);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Buttons */
    .btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.22), var(--glow);
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.09);
      border-color: rgba(249,168,37,.35);
    }
    .btn.danger{
      border-color: rgba(211,47,47,.35);
    }
    .btn.danger:hover{
      border-color: rgba(211,47,47,.55);
    }

    /* Legend pills */
    .legend{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      box-shadow: 0 8px 14px rgba(0,0,0,.18), var(--glow);
      color: var(--muted);
      font-weight: 850;
      font-size: 12px;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 4px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    .d-wip{ background: var(--wip); }
    .d-av{ background: var(--available); }
    .d-od{ background: var(--overdue); }
    .d-na{ background: var(--na); }
    .d-pre{ background: var(--pre); }

    /* Layout */
    main{
      position:relative;
      z-index:1;
      max-width: 1520px;
      margin: 0 auto;
      padding: 18px 16px 34px;
      display:flex;
      flex-direction:column;
      gap: 18px;
    }

    /* Section panels */
    .section{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .sectionHead{
      padding: 16px 16px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(900px 120px at 0% 0%, rgba(255,255,255,.08), transparent 65%),
        rgba(0,0,0,.15);
    }
    .sectionTitle{
      margin:0;
      font-weight: 950;
      font-size: 18px;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sectionSub{
      color: var(--muted);
      font-weight: 850;
      font-size: 12px;
      white-space:nowrap;
    }

    .sectionBody{
      padding: 14px;
    }

    /* Tiles grid */
    .tiles{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 12px;
      align-items:stretch;
    }

    /* Tile */
    .tile{
      position:relative;
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow2), var(--glow);
      padding: 12px 12px 11px;
      min-height: 98px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      transition: transform 130ms ease, border-color 130ms ease, background 130ms ease;
      isolation:isolate;
    }
    .tile:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
    }

    /* Status accent bar */
    .tile::before{
      content:"";
      position:absolute;
      inset:0;
      width: 6px;
      background: rgba(255,255,255,.18);
      z-index:-1;
    }
    .tile.wip::before{ background: linear-gradient(180deg, rgba(46,125,50,1), rgba(46,125,50,.45)); }
    .tile.available::before{ background: linear-gradient(180deg, rgba(249,168,37,1), rgba(249,168,37,.45)); }
    .tile.overdue::before{ background: linear-gradient(180deg, rgba(239,108,0,1), rgba(239,108,0,.45)); }
    .tile.na::before{ background: linear-gradient(180deg, rgba(211,47,47,1), rgba(211,47,47,.45)); }
    .tile.pre::before{ background: linear-gradient(180deg, rgba(10,166,180,1), rgba(10,166,180,.45)); }

    /* Badge */
    .badge{
      position:absolute;
      top:10px;
      right:10px;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 11px;
      font-weight: 950;
      color: rgba(0,0,0,.9);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.15);
      box-shadow: 0 10px 16px rgba(0,0,0,.25);
    }

    .tileTop{
      padding-left: 10px; /* because accent bar */
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .itemCode{
      font-weight: 950;
      letter-spacing: .25px;
      font-size: 16px;
      line-height: 1.1;
      white-space: nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      color: var(--muted);
      font-weight: 850;
      font-size: 12px;
      line-height: 1.25;
    }
    .meta b{ color: rgba(234,242,255,.92); font-weight: 950; }

    /* Actions */
    .actions{
      padding-left: 10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 2px;
    }
    .smallBtn{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      box-shadow: 0 10px 16px rgba(0,0,0,.20), var(--glow);
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    .smallBtn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.11);
      border-color: rgba(249,168,37,.25);
    }
    .smallBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    /* Empty */
    .empty{
      border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.20);
      padding: 18px;
      text-align:center;
      color: var(--muted);
      font-weight: 850;
      box-shadow: 0 10px 16px rgba(0,0,0,.20);
    }

    /* Mobile */
    @media (max-width: 820px){
      .topbar{
        grid-template-columns: 1fr;
      }
      .leftActions, .rightActions{ justify-content:center; }
      .title{ white-space:normal; }
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="leftActions">
        <button id="backBtn" class="btn" type="button" style="display:none;">← Back</button>
      </div>

      <div class="titleWrap">
        <h1 class="title" id="stationTitle">Loading…</h1>
        <div class="legend" aria-label="Legend">
          <div class="pill"><span class="dot d-wip"></span> Work in Progress</div>
          <div class="pill"><span class="dot d-av"></span> Available to Bend</div>
          <div class="pill"><span class="dot d-od"></span> Overdue</div>
          <div class="pill"><span class="dot d-na"></span> Not Available</div>
          <div class="pill"><span class="dot d-pre"></span> Pre-Production</div>
        </div>
      </div>

      <div class="rightActions">
        <button id="logoutBtn" class="btn danger" type="button">Log out</button>
      </div>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="sectionHead">
        <h2 class="sectionTitle">Work in Progress</h2>
        <div class="sectionSub" id="wipCount">—</div>
      </div>
      <div class="sectionBody" id="wipBody">Loading…</div>
    </section>

    <section class="section">
      <div class="sectionHead">
        <h2 class="sectionTitle">Available to Bend</h2>
        <div class="sectionSub" id="availableCount">—</div>
      </div>
      <div class="sectionBody" id="availableBody">Loading…</div>
    </section>

    <section class="section">
      <div class="sectionHead">
        <h2 class="sectionTitle">Not Available</h2>
        <div class="sectionSub" id="naCount">—</div>
      </div>
      <div class="sectionBody" id="naBody">Loading…</div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, onSnapshot,
      runTransaction, serverTimestamp, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD-ArzjlwKTZVpsH4ERg7n-MEgzCt6Nzno",
      authDomain: "prodalign-ltd.firebaseapp.com",
      projectId: "prodalign-ltd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const backBtn = document.getElementById("backBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const stationTitleEl = document.getElementById("stationTitle");

    const wipBody = document.getElementById("wipBody");
    const availableBody = document.getElementById("availableBody");
    const naBody = document.getElementById("naBody");

    const wipCount = document.getElementById("wipCount");
    const availableCount = document.getElementById("availableCount");
    const naCount = document.getElementById("naCount");

    // URL params
    const params = new URLSearchParams(window.location.search);
    const companyId = (params.get("c") || "").trim().toLowerCase();
    const stationParam = (params.get("station") || "").trim();

    if (!companyId) {
      window.location.assign("/companylogin/");
      throw new Error("Missing ?c=");
    }

    // ---------- Helpers ----------
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function prettyStationName(s) {
      return String(s || "")
        .trim()
        .toLowerCase()
        .replace(/[_-]+/g, " ")
        .split(" ")
        .filter(Boolean)
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(" ");
    }

    function normalizeOpsArray(ops){
      if (!Array.isArray(ops)) return [];
      return ops
        .map(x => {
          const code = String(x?.code || "").trim().toUpperCase();
          const iph = Number(x?.iph);
          return code ? { code, iph: Number.isFinite(iph) ? iph : 0 } : null;
        })
        .filter(Boolean);
    }

    function getUserIdentifier(){
      const u = auth.currentUser;
      return u?.email || u?.displayName || u?.uid || "unknown";
    }

    function renderEmpty(el, text){
      el.innerHTML = `<div class="empty">${escapeHtml(text)}</div>`;
    }

    // Per-device kiosk session id
    function getKioskDeviceId() {
      let id = localStorage.getItem("kioskDeviceId");
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem("kioskDeviceId", id);
      }
      return id;
    }
    function getKioskSessionId(uid) {
      return `${uid}_${getKioskDeviceId()}`;
    }

    async function hardKickToLogin() {
      try { await signOut(auth); } catch {}
      window.location.assign("/companylogin/");
    }

    // ---------- Gate / Station selection ----------
    async function enforceGate(user) {
      const snap = await getDoc(doc(db, "users", user.uid));
      if (!snap.exists()) throw new Error("User profile missing.");

      const data = snap.data() || {};
      const userCompany = String(data.companycode ?? data.companyCode ?? "").trim().toLowerCase();
      const role = String(data.role ?? "").trim().toLowerCase();
      const license = String(data.license ?? "").trim().toLowerCase();
      const isAdmin = Boolean(data.isAdmin) || role === "admin" || license === "admin";

      if (!userCompany || userCompany !== companyId) throw new Error("Wrong company.");

      backBtn.style.display = isAdmin ? "inline-flex" : "none";

      const allowed = (role === "operator") || isAdmin;
      if (!allowed) throw new Error("Not allowed for this dashboard.");

      const sessionId = getKioskSessionId(user.uid);
      const sessSnap = await getDoc(doc(db, "kioskSessions", sessionId));

      let stationFromSession = "";
      let sessCompany = "";

      if (sessSnap.exists()) {
        const sess = sessSnap.data() || {};
        stationFromSession = String(sess.stationId || "").trim();
        sessCompany = String(sess.companyId || "").trim().toLowerCase();
      }

      let station = "";
      if (isAdmin) {
        station = stationFromSession && (sessCompany === companyId) ? stationFromSession : "";
        if (!station && stationParam) station = stationParam;
      } else {
        station = stationFromSession && (sessCompany === companyId) ? stationFromSession : "";
      }

      if (!station) {
        window.location.assign(`/company/StationPin.html?c=${encodeURIComponent(companyId)}`);
        return null;
      }

      if (isAdmin && station && (!stationFromSession || sessCompany !== companyId)) {
        try {
          await setDoc(doc(db, "kioskSessions", sessionId), {
            uid: user.uid,
            companyId: companyId,
            stationId: station,
            stationName: station,
            stationCode: station,
            updatedAt: serverTimestamp(),
            createdAt: serverTimestamp()
          }, { merge: true });
        } catch (e) {
          console.warn("Admin kiosk session write blocked (rules):", e);
        }
      }

      const desiredUrl = `/company/FloorDashboard.html?c=${encodeURIComponent(companyId)}&station=${encodeURIComponent(station)}`;
      const currentUrl = location.pathname + location.search;
      if (currentUrl !== desiredUrl) {
        window.location.replace(desiredUrl);
        return null;
      }

      stationTitleEl.textContent = `${prettyStationName(station)} Dashboard`;
      return { station, isAdmin };
    }

    // ---------- Optional flags ----------
    function isOverdue(job){
      const flag = Boolean(job.isOverdue || job.overdue);
      if (flag) return true;

      const due = job.dueAt || job.dueDate || job.due;
      if (!due) return false;

      let dueMs = 0;
      if (typeof due === "number") dueMs = due;
      else if (typeof due?.toMillis === "function") dueMs = due.toMillis();
      else {
        const parsed = Date.parse(String(due));
        dueMs = Number.isFinite(parsed) ? parsed : 0;
      }
      return Boolean(dueMs && Date.now() > dueMs);
    }

    function isPreProduction(job){
      return Boolean(job.preProduction || job.preProductionRun || job.isPreProduction);
    }

    function badgeValue(job){
      if (Number.isFinite(Number(job.priority))) return Number(job.priority);
      if (Number.isFinite(Number(job.sequence))) return Number(job.sequence);
      if (Number.isFinite(Number(job.currentOpIndex))) return Number(job.currentOpIndex) + 1;
      return "";
    }

    // ---------- Live jobs ----------
    function watchJobsForStation(stationId){
      const stationCode = String(stationId || "").trim().toUpperCase();
      if (!stationCode) return;

      const jobsRef = collection(db, "companies", companyId, "jobs");

      return onSnapshot(jobsRef, (snap) => {
        const available = [];
        const wip = [];
        const notAvailable = [];

        snap.forEach((d) => {
          const job = d.data() || {};
          const id = d.id;

          const st = String(job.status || "").toLowerCase();
          if (st === "complete" || st === "booked" || st === "to_book") return;

          const ops = normalizeOpsArray(job.ops);
          const currentOpIndex = Number(job.currentOpIndex ?? 0);

          const myIndex = ops.findIndex(o => o.code === stationCode);
          if (myIndex === -1) return;
          if (currentOpIndex > myIndex) return;

          const status = String(job.status || "").trim().toLowerCase();

          const jobView = {
            id,
            itemCode: String(job.itemCode || "").toUpperCase(),
            orderNo: String(job.orderNo || job.productionOrder || ""),
            qty: Number(job.qty || job.orderQty || 0),
            currentOpIndex,
            currentOpCode: String(job.currentOpCode || "").trim().toUpperCase(),
            status,
            assignedTo: String(job.assignedTo || ""),
            _raw: job
          };

          if (currentOpIndex === myIndex) {
            if (status === "ready") available.push(jobView);
            else wip.push(jobView);
          } else {
            notAvailable.push(jobView);
          }
        });

        renderAll({ stationCode, available, wip, notAvailable });
      }, (err) => {
        console.error("Jobs listener error:", err);
        renderEmpty(availableBody, `Error loading jobs: ${err.message}`);
        renderEmpty(wipBody, `Error loading jobs: ${err.message}`);
        renderEmpty(naBody, `Error loading jobs: ${err.message}`);
      });
    }

    // ---------- Render ----------
    function setCounts(wip, available, na){
      wipCount.textContent = `${wip} job${wip===1?"":"s"}`;
      availableCount.textContent = `${available} job${available===1?"":"s"}`;
      naCount.textContent = `${na} job${na===1?"":"s"}`;
    }

    function renderAll({ stationCode, available, wip, notAvailable }){
      setCounts(wip.length, available.length, notAvailable.length);

      if (!wip.length) renderEmpty(wipBody, "No jobs in progress at this station.");
      else {
        wipBody.innerHTML = `<div class="tiles">${wip.map(j => tileHtml(j, stationCode, "wip")).join("")}</div>`;
        wireTileButtons(wipBody, stationCode);
      }

      if (!available.length) renderEmpty(availableBody, "No jobs ready for this station.");
      else {
        availableBody.innerHTML = `<div class="tiles">${available.map(j => tileHtml(j, stationCode, "available")).join("")}</div>`;
        wireTileButtons(availableBody, stationCode);
      }

      if (!notAvailable.length) renderEmpty(naBody, "Nothing waiting on previous operations.");
      else {
        naBody.innerHTML = `<div class="tiles">${notAvailable.map(j => tileHtml(j, stationCode, "na")).join("")}</div>`;
      }
    }

    function tileHtml(job, stationCode, bucket){
      const raw = job._raw || {};
      const overdue = isOverdue(raw);
      const pre = isPreProduction(raw);

      let cls = bucket;
      if (bucket === "available" && overdue) cls = "overdue";
      if (pre) cls = "pre";

      const badge = badgeValue(raw);

      const item = job.itemCode || "—";
      const po = job.orderNo || "—";
      const qty = Number.isFinite(job.qty) ? job.qty : 0;

      let actions = "";
      if (bucket === "available") {
        actions = `<div class="actions">
          <button class="smallBtn" data-start="${escapeHtml(job.id)}">Start</button>
        </div>`;
      } else if (bucket === "wip") {
        actions = `<div class="actions">
          <button class="smallBtn" data-complete="${escapeHtml(job.id)}">Complete</button>
        </div>`;
      }

      return `
        <div class="tile ${cls}">
          ${badge !== "" ? `<div class="badge">${escapeHtml(String(badge))}</div>` : ``}

          <div class="tileTop">
            <div class="itemCode">${escapeHtml(item)} × ${escapeHtml(String(qty))}</div>
            <div class="meta">
              <div><b>Production Order:</b> ${escapeHtml(po)}</div>
              <div><b>Current:</b> ${escapeHtml(job.currentOpCode || "—")}</div>
              ${job.assignedTo ? `<div><b>Assigned:</b> ${escapeHtml(job.assignedTo)}</div>` : ``}
            </div>
          </div>

          ${actions}
        </div>
      `;
    }

    function wireTileButtons(container, stationCode){
      container.querySelectorAll("button[data-start]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-start");
          btn.disabled = true;
          try{ await startJob(id, stationCode); }
          catch(e){ console.error(e); alert(e?.message || "Could not start job."); btn.disabled=false; }
        });
      });

      container.querySelectorAll("button[data-complete]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-complete");
          btn.disabled = true;
          try{ await completeJobStep(id, stationCode); }
          catch(e){ console.error(e); alert(e?.message || "Could not complete job."); btn.disabled=false; }
        });
      });
    }

    // ---------- Actions ----------
    async function startJob(jobId, stationCode){
      const jobRef = doc(db, "companies", companyId, "jobs", jobId);

      await runTransaction(db, async (tx) => {
        const snap = await tx.get(jobRef);
        if (!snap.exists()) throw new Error("Job not found.");

        const job = snap.data() || {};
        const status = String(job.status || "").toLowerCase();
        const currentOpCode = String(job.currentOpCode || "").toUpperCase();

        if (status !== "ready") throw new Error("This job is not available.");
        if (currentOpCode !== stationCode) throw new Error("This job is not for your station.");

        tx.update(jobRef, {
          status: "in_progress",
          assignedTo: getUserIdentifier(),
          startedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      });
    }

    async function completeJobStep(jobId, stationCode){
      const jobRef = doc(db, "companies", companyId, "jobs", jobId);

      await runTransaction(db, async (tx) => {
        const snap = await tx.get(jobRef);
        if (!snap.exists()) throw new Error("Job not found.");

        const job = snap.data() || {};
        const ops = normalizeOpsArray(job.ops);
        const idx = Number(job.currentOpIndex ?? 0);
        const currentOpCode = String(job.currentOpCode || "").toUpperCase();

        if (!ops.length) throw new Error("Job has no operations.");
        if (currentOpCode !== stationCode) throw new Error("This job is not at your station.");

        const nextIndex = idx + 1;

        if (nextIndex < ops.length) {
          tx.update(jobRef, {
            currentOpIndex: nextIndex,
            currentOpCode: ops[nextIndex].code,
            status: "ready",
            assignedTo: null,
            updatedAt: serverTimestamp()
          });
        } else {
          tx.update(jobRef, {
            status: "to_book",
            assignedTo: null,
            completedAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        }
      });
    }

    // ---------- Auth gate ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.assign("/companylogin/");
        return;
      }

      try{
        const result = await enforceGate(user);
        if (!result) return;
        watchJobsForStation(result.station);
      }catch(e){
        console.error(e);
        await hardKickToLogin();
      }
    });

    // Admin back
    backBtn.addEventListener("click", () => {
      window.location.assign(`/company/?c=${encodeURIComponent(companyId)}`);
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      try{
        const user = auth.currentUser;
        if (user){
          const sessionId = getKioskSessionId(user.uid);
          try{ await deleteDoc(doc(db, "kioskSessions", sessionId)); }catch{}
        }
      }catch{}

      try{ await signOut(auth); }catch{}
      window.location.assign(`/companylogin/?c=${encodeURIComponent(companyId)}`);
    });
  </script>
</body>
</html>
